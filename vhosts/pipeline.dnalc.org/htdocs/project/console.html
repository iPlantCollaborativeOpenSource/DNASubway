
<%args>
	$pid => 0
	$debug => 0
</%args>
%#-------------------------------------------------
<%once>
	use Data::Dumper; 
	use DNALC::Pipeline::Project ();
	use DNALC::Pipeline::App::WorkflowManager ();
	use DNALC::Pipeline::App::Utils ();

	my @routines = (
			{ name => 'trna_scan', label => 'tRNA Scan'},
			{ name => 'augustus', label => 'Augustus', delay => 15},
			{ name => 'fgenesh', 'label' => 'FgenesH'},
			#{ name => 'repeat_masker', label => 'Repeat Masker', delay => 10},
			{ name => 'snap', label => 'Snap'},
			{ name => 'blastn', label => 'BlastN'},
			{ name => 'blastx', label => 'BlastX'},
		);
	my %clades = (
			d => 'Eudicotyledons',
			m => 'Monocotyledons',
			u => 'Undefined',
			o => 'Other'
		);
</%once>
%#-------------------------------------------------
<%init>

$m->session->{pipeline} ||= {};
my $s = $m->session->{pipeline};

my $proj = DNALC::Pipeline::Project->retrieve($pid);
unless ($proj) {
	$m->comp('/_message_add', 'Project not found!', 'error');
	$m->redirect('/project/');
}

my $wfm = DNALC::Pipeline::App::WorkflowManager->new( $proj );
my $history = $wfm->get_history;

my %status = ();
for ('repeat_masker', map {$_->{name}} @routines ) {
	my $status_name = lc $wfm->get_status($_)->name;
	$status_name =~ s/\s/-/;
	$status{$_} = $status_name;
}
my $rm_status = $status{repeat_masker};

my $trimmed_common_name = $proj->common_name . '_' . $proj->id;
$trimmed_common_name =~ s/\s+/_/g;
$trimmed_common_name =~ s/-/_/g;


#print STDERR Dumper( \%status ), $/;
# TODO : set in session when you're starting to run a routine, 
# and reset this flash after you get info about the execution of the routine
</%init>
%#-------------------------------------------------
<div id="container_devicebg2"></div>
<div id="container_top">
	<div id="learn_head"><a href="/learnlearn.html" style="padding-left: 10px;">Learn</a></div>
	<!--<div id="logout_head"><a href="home.html" style="padding-left: 10px;">Log Out</a></div>-->
    <div id="backhome"><a href="index.html"></a></div>
    <div id="backtoconsole_head">CONSOLE</div>
    <div id="backtoloader_head"><a href="/project/browse">PROJECTS</a></div>
    
</div> <!-- #container_top  -->

<div id="container_content_member3">
	<& "/_messages" &>
<input type="hidden" id="pid" value="<% $pid %>"/>
	<div id="container_pagehead">
		<div id="container_pagetitle">:: CONSOLE ::</div>
		<div id="container_membername">User: Guest</div>
	</div>

	<div id="container_commandertitle"><% $proj->name |html%></div>
	<div id="container_commanderblurb"><p>Use the console to perform DNA analysis routines on the loaded sequence. To begin, "Prepare Sequence." This key pre-requisite analysis identifies and masks simple repeats and transposons, thus removing sequence that may clutter subsequent analyses. Next, run any or all of the analysis algorithms under "Predict Genes" and/or "Conduct <em>Blast</em> Searches." Finally, launch “GBrowse” viewer or the "<em>Apollo</em>" editor to further analyze and annotate the sequence.</p>
	</div>
	<div id="container_project">
		<div class="commandertitle_member">Project</div>
% if (1) {
<!-- ---------------------------------------- -->
	<div style="height:40px">&nbsp;</div>
<table border="0" cellpadding="1" style="margin-left: 20px;margin-right: auto; width: 278px">
  <tr >
    <td class="tdprojectlabel">User</td>
    <td class="tdprojectinfo">: Guest</td>
</tr>
<tr>
	<td class="tdprojectlabel">Group/Affiliation</td>
    <td class="tdprojectinfo">: DNALC</td>
</tr>
<tr>
	<td class="tdprojectlabel">Project ID</td>
	<td class="tdprojectinfo">: <% $proj->id %></td>
<tr>
  	<td class="tdprojectlabel">Organism</td>
	<td class="tdprojectinfo">: <% $proj->common_name %></td>
</tr>
<tr>
	<td class="tdprojectlabel">Classification</td>
	<td class="tdprojectinfo">: <% $clades{$proj->clade} %></td>
</tr>
<tr>
	<td class="tdprojectlabel" style="vertical-align: top">Sequence size</td>
	<td class="tdprojectinfo"><span style="vertical-align: top">: <% $proj->sequence_length %> &nbsp;</span><a href="javascript:;" onclick="launch(null, '<& './.comp/filepath_to_web', file => $proj->fasta_file &>')"><img id="view_seq_btn" src="/images/v0/button_viewDown.png" alt="open sequence" style="border: 0px; margin-top: -3px" /></a></td>
</tr>
</table>
<!--   ----   -->

<div class="historylist"> <!-- history start -->
<div class="tdproject_empty"><img src="/images/v0/dot_blue.png" />&nbsp;History</div>
<ul>
% for my $h (@$history) {
	<li class="closed">
	<strong><% $h->{task_name} %></strong>,\
% if ($h->{duration} > 0) {
	<% $h->{duration}%> sec., 
% }
	<% DNALC::Pipeline::App::Utils->format_datetime($h->{created}) %>
	</li>
% }
</ul>
</div><!-- history end -->
<div id="debug" style="display:<% $debug ? 'block' : 'none'%>"></div>
% }
</div> <!-- #container_project -->


<div id="container_analyses">
	<div class="commandertitle_member">Analyses</div>
% if (1) {
	<div id="container_analyses1">
		<div class="analysesTexttitle"><img src="/images/v0/dot_blue.png" />&nbsp;<span class="p2">Prepare Sequence</span></div>

        <table width="390" border="0px" cellpadding="1">
		  <tr>
  		    <td class="tdtext">Identify and mask Repetitive DNA &amp; transposons</td>
			<td class="tdinfo">
				<a href="#" class="tt">i<span class="tooltip"><span class="top"></span><span class="middle">Info about this routine will be available soon. Thank you for your patience.</span><span class="bottom"></span></span></a>
			</td>
			<td class="">
				<& '.routine', routine => 'repeat_masker', project => $proj,
								status => $status{repeat_masker}, delay => 15 &>
			</td>
		  </tr>
		</table>

		<div class="analysesTexttitle"></div>
		<div class="analysesTexttitle"><img src="/images/v0/dot_blue.png" />&nbsp;<span class="p2">Predict Genes</span></div>
        <table width="390" border="0px" cellpadding="1">
		   <tr>
			<td class="tdtext">Augustus gene predictor</td>
			<td class="tdinfo"><a href="#" class="tt">i<span class="tooltip"><span class="top"></span><span class="middle">Info about this routine will be available soon. Thank you for your patience.</span><span class="bottom"></span></span></a></td>
			<td class="">
				<& '.routine', routine => 'augustus', project => $proj,
								status => $status{augustus}, delay => 20, rm_status => $rm_status &>
			</td>
		  </tr>
		  <tr>
			<td class="tdtext">FGenesH gene predictor</td>
			<td class="tdinfo"> <a href="#" class="tt">i<span class="tooltip"><span class="top"></span><span class="middle">Info about this routine will be available soon. Thank you for your patience.</span><span class="bottom"></span></span></a></td>
			<td class="" style="border:none">
				<& '.routine', routine => 'fgenesh', project => $proj,
								status => $status{fgenesh}, rm_status => $rm_status &>
		  </tr>

		   <tr>
			<td class="tdtext">SNAP gene predictor</td>
			<td class="tdinfo"><a href="#" class="tt">i<span class="tooltip"><span class="top"></span><span class="middle">Info about this routine will be available soon. Thank you for your patience.</span><span class="bottom"></span></span></a></td>
			<td class="">
				<& '.routine', routine => 'snap', project => $proj,
				status => $status{snap}, rm_status => $rm_status &>
			</td>
		  </tr>
		 <tr>
			<td class="tdtext">tRNA gene predictor</td>
			<td class="tdinfo">
				<a href="#" class="tt">i<span class="tooltip"><span class="top"></span><span class="middle">Info about this routine will be available soon. Thank you for your patience.</span><span class="bottom"></span></span></a>
			</td>
			<td class="">
				<& '.routine', routine => 'trna_scan', project => $proj,
								status => $status{trna_scan}, rm_status => $rm_status &>
			</td>
		  </tr>
		</table>


	<div class="analysesTexttitle"></div>
	<div class="analysesTexttitle"><img src="/images/v0/dot_blue.png" />&nbsp;<span class="p2">Search Databases</span></div>

	<table width="390" border="0px" cellpadding="1">
	  <tr>
		<td class="tdtext">BlastX for protein homologs</td>
		<td class="tdinfo"><a href="#" class="tt">i<span class="tooltip"><span class="top"></span><span class="middle">Info about this routine will be available soon. Thank you for your patience.</span><span class="bottom"></span></span></a></td>
		<td class="">
					<& '.routine', routine => 'blastx', project => $proj, delay => 15,
					status => $status{blastx}, rm_status => $rm_status &>
		</td>
	  </tr>
	   <tr>
		<td class="tdtext">BlastN for RNA evidence (cDNA, EST)</td>
		<td class="tdinfo"><a href="#" class="tt">i<span class="tooltip"><span class="top"></span><span class="middle">Info about this routine will be available soon. Thank you for your patience.</span><span class="bottom"></span></span></a></td>
		<td class="">
					<& '.routine', routine => 'blastn', project => $proj, delay => 15,
					status => $status{blastn}, rm_status => $rm_status &>
		</td>
	  </tr> 
	</table>


% if (0) {
<ul id="routines" style="clear:both">
%#------------------------------------	
	<li><span style="font-weight:bold">Repeat Masker</span>&nbsp;
%	if ($rm_status !~ /Done|Processing/) {
%#	if ($rm_status ne 'Processing') 
<input type="button" id="repeat_masker_btn" value="Run" onclick="run('repeat_masker')" />
%	}
<span class="<%lc $rm_status %>" id="repeat_masker" delay="10" status="<%$rm_status%>">
%	if ($rm_status eq 'Done') {
%		my $path = $m->comp('./.comp/filepath_to_web', file => $proj->get_gff3_file('repeat_masker') || '#', just_return => 1);
%		if ($path) {
			<a target="_blank" href="<% $path %>">View output</a>
%		}
%   } else {
	<% $rm_status %>\
%	}
		</span>
	</li>
%#------------------------------------	
% for my $rt (@routines) {
%	last;
%	my $rname = $rt->{name};
%	my $rt_status = $wfm->get_status($rname)->name;
%	my $disabled = $rname ne 'trna_scan' && $rm_status ne 'Done';
	<li><span style="font-weight:bold"><% $rt->{label} %></span>&nbsp;
%#	if ($rt_status !~ /Done|Processing/)
%	if ($rt_status ne 'Processing') {
<input type="button" id="<% $rname %>_btn" value="Run" onclick="run('<% $rname %>')" <% $disabled ? 'disabled="disabled"' : '' %>/>
%	}
<span class="<%lc $rt_status %>" id="<% $rname %>" delay="<% $rt->{delay} || 5 %>" status="<%$rt_status%>">
%	if ($rt_status eq 'Done') {
%		my $path = $m->comp('./.comp/filepath_to_web', file => $proj->get_gff3_file($rname) || '', just_return => 1);
%		if ($path) {
			<a target="_blank" href="<% $path %>">View output</a>
%		}
%   } else {
	<% $rt_status %>\
%	}
		</span>
	</li>
% }

</ul>
% } # end_if
</div> <!-- #container_analyses1 -->
% }
</div> <!-- #container_analyses -->




<div id="container_launch">
	<div class="commandertitle_member">Launch</div>
	<div style="height:40px">&nbsp;</div>

	<div class="container_launch1"><img src="/images/v0/dot_blue.png" /><span class="p2">&nbsp;Browser</span>
		<div class="spacer"></div><br />
		<div class="launch_gbrowse">
			<a id="gbrowse_btn" class="<% $rm_status ne 'done' ? 'disabled' : '' %>" \
			onclick="<% $rm_status eq 'done' ? "launch('gbrowse')" : '' %>" \
			href="javascript:;"></a>
		</div>
	</div>    

	<div class="container_launch1">
		<img src="/images/v0/dot_blue.png" /><span class="p2">&nbsp;Editor</span>
		<div class="spacer"></div>
		    <br />

		<div class="launch_apollo">
			<a id="apollo_btn" class="<% $rm_status ne 'done' ? 'disabled' : '' %>" \
				commonname="<% $trimmed_common_name %>" seq_length="<% $proj->sequence_length %>" \
				onclick="<% $rm_status eq 'done' ? "launch('apollo')" : '' %>" href="javascript:;"></a>
		</div>
		<div id="apollo_status" style="padding-top:10px; height: 40px; display: none; background: yellow;">
			Preparing files. stand by...
		</div>
	</div>

% if ($proj->sample) {
	<br />
	<div class="container_launch1"><img src="/images/v0/dot_blue.png" />
		<span class="p2">&nbsp;Exporter</span>
		<div class="spacer"></div>
		    <br />
		<div class="launch_exporter"><a href="#"></a></div>
	</div>
% }

<!--
<div id="gbrowse" style="display:block"><a href="./prepare_gbrowse?pid=<% $proj->id%>">Browse</a></div>
-->
</div> <!-- #container_launch -->
</div> <!-- #container_content_member3 -->


%#----------------------------------------------------------------------------
<%def .routine>
<%args>
	$routine => ''
	$rm_status => 'not-processed'
	$status => 'disabled'
	$project => undef
	$delay => 5
</%args>
<%init>
my $link = 'javascript:;';
my $target = 'target="_blank"';
my $action = qq{onclick="run('$routine')"};
my $title  = '';

if ($status eq 'processing') {
	$action = '';
	$target = '';
	$title = 'Processing';
}
elsif ($status eq 'done') {
	my $url = $m->comp('./.comp/filepath_to_web', file => $project->get_gff3_file($routine) || '#', just_return => 1); 
	$action = qq{onclick="launch(null, '$url')"};
	$target = '';
	$title  = 'Click to view results';
} 
else {
	if ($rm_status ne 'done' && $routine !~ /trna_scan|repeat_masker/) {
		$status = 'disabled';
		$action = '';
		$title = 'Identify repeats first';
	}
	else {
		$title = 'Click to process';
	}
	$target = '';
}
</%init>
<a id="<% $routine %>_btn" href="<% $link %>" class="<% $status %>" <% $target %>\
 status="<% $status %>" <% $action %> delay="<% $delay %>" title="<% $title %>" ></a>
</%def>
%#----------------------------------------------------------------------------
<%attr>
	js => ['console.js']
	css => ['device.css']
	load_window_ui => 1
</%attr>

%# vim: ft=mason

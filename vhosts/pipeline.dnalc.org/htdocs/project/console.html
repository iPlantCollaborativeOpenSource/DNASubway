<div id="container_rightContent">  
<input type="hidden" id="pid" value="<% $pid %>"/>

%	if (exists $m->session->{messages}) {
<div style="display:none" id="error_list">	
	<& "/_messages" &>
</div>
% 	}

<!--Left Content Start--------------> 
<div id="conRedlineLeft2">
          <span class="conRedline_ConColumn">
     		<span class="conRedline_ConCell">
            		<div class="conIndicator_box"><div id="repeat_masker_st" class="conIndicator_<% $status{repeat_masker} %>"></div> </div>
					<& '.routine', routine => 'repeat_masker', pmanager => $pm,
						status => $status{repeat_masker}, delay => 15 &>
            </span><!--END of span class conRedline_ConCell-->
            <span class="conRedline_keys">
            </span>
     </span><!--END of span class conRedline_ConColumn-->
    
    
    <span class="conRedline_ConColumn">
		<span class="conRedline_ConCell">
		<span class="conIndicator_box"><div id="augustus_st" class="conIndicator_<% $status{repeat_masker} eq "done" ? $status{augustus} : "disabled" %>"></div> </span>
%#		<span class="bt_run"><a href="#">Augustus</a></span>
			<& '.routine', routine => 'augustus', pmanager => $pm,
				status => $status{augustus}, delay => 20, rm_status => $rm_status &>
		</span><!--END of span class conRedline_ConCell-->
		<span class="conRedline_ConCell">
			<span class="conIndicator_box"><div id="fgenesh_st" class="conIndicator_<% $status{repeat_masker} eq "done" ? $status{fgenesh} : "disabled" %>"></div> </span>
%#			<span class="bt_run"><a href="#">FGenesH</a></span>
			<& '.routine', routine => 'fgenesh', pmanager => $pm,
						status => $status{fgenesh}, rm_status => $rm_status &>
		</span><!--END of span class conRedline_ConCell-->
		<span class="conRedline_ConCell">
			<span class="conIndicator_box"><div id="snap_st" class="conIndicator_<% $status{repeat_masker} eq "done" ? $status{snap} : "disabled" %>"></div> </span>
%#			<span class="bt_run"><a href="#">SNAP</a></span>
			<& '.routine', routine => 'snap', pmanager => $pm,
						status => $status{snap}, rm_status => $rm_status &>
		</span><!--END of span class conRedline_ConCell-->
		<span class="conRedline_ConCell">
			<span class="conIndicator_box"><div id="trna_scan_st" class="conIndicator_<% $status{trna_scan} %>"></div> </span>
%#			<span class="bt_run"><a href="#">tRNA</a></span>
			<& '.routine', routine => 'trna_scan', pmanager => $pm,
						status => $status{trna_scan}, rm_status => $rm_status &>
		</span><!--END of span class conRedline_ConCell-->
     </span><!--END of class conRedline_ConColumn-->

	<span class="conRedline_ConColumn">     
		<span class="conRedline_ConCell">
			<span class="conIndicator_box"><div id="blastn_st" class="conIndicator_<% $status{repeat_masker} eq "done" ? $status{blastn} : "disabled" %>"></div> </span>
			<& '.routine', routine => 'blastn', pmanager => $pm, delay => 15,
						status => $status{blastn}, rm_status => $rm_status &>
		</span><!--END of span class conRedline_ConCell-->

		<span class="conRedline_ConCell">
			<span class="conIndicator_box"><div id="blastx_st" class="conIndicator_<% $status{repeat_masker} eq "done" ? $status{blastx} : "disabled" %>"></div></span>
			<& '.routine', routine => 'blastx', pmanager => $pm, delay => 15,
						status => $status{blastx}, rm_status => $rm_status &>
		</span><!--END of span class conRedline_ConCell-->
		
		
% my $nt_evid = lc $wfm->get_status("upload_evid_nt")->name;
% my $prot_evid = lc $wfm->get_status("upload_evid_prot")->name;
% if ( $nt_evid eq "done") {
		<span class="conRedline_ConCellAdd">
			<span class="conIndicator_box"><div id="blastn_user_st" class="conIndicator_<% $status{blastn_user} %>"></div></span>
			<& '.routine', routine => 'blastn_user', pmanager => $pm, delay => 15,
					status => $status{blastn_user}, rm_status => $rm_status &>
		</span><!--END of span class conRedline_ConCell-->
% } else {
	<span class="conRedline_ConCell"></span>
% }
		
		
% if ($prot_evid eq "done") {
		<span class="conRedline_ConCellAdd"> <!-- conRedline_ConCell -->
			<span class="conIndicator_box"><div id="blastx_user_st" class="conIndicator_<% $status{blastx_user} %>"></div></span>
			<& '.routine', routine => 'blastx_user', pmanager => $pm, delay => 15,
					status => $status{blastx_user}, rm_status => $rm_status &>
		</span><!--END of span class conRedline_ConCell-->
% } else {
		<span class="conRedline_ConCell"></span>
% }
		

% if ( $nt_evid ne "done" || $prot_evid ne "done") {
		<span class="conRedline_ConCell2">
			<span class="conIndicator_box"></span>
			<span class="bt_run">
			
			<span style="position:relative;">
				<div id="add_evidence" class="popup">
				<form enctype="multipart/form-data" method="post">
% if ( $nt_evid ne "done") {
					<div class="panel_container">Add Nucleotide based evidence:                     
						<input class="conStylized_box1" type="file" id="evid_nt" name="evid_nt"/>
					</div>
% }
% if ( $prot_evid ne "done") {
					<div class="panel_container">Add Proteine based evidence:                      
						<input class="conStylized_box1" type="file" id="evid_prot" name="evid_prot"/>
					</div>
% }
					<div class="panel_container1">
						<input type="button" value="  Cancel  " class="input" onclick="javascript:$('add_evidence').hide();$('add_evidence_link').show();" /> &nbsp; &nbsp; &nbsp; &nbsp;
						<input type="submit" value="  Upload  " class="input" />
					</div>
				</form>
				</div>
				<a id="add_evidence_link" href="javascript:void(0);" \
				onclick="javascript:$('add_evidence').style.visibility='visible';$('add_evidence').style.display='block';$('add_evidence_link').hide();">Upload Data</a>
			</span>

		</span><!--END of span class conRedline_ConCell-->
	</span>		
% }
	</span><!--END of class conRedline_ConColumn-->
</div><!--END of ID conRedlineLeft2-->

<!--right Content Start--------------> 
<div id="conRedlineRight2">
	<span id="conRedline_ConColumnR1"><span class="bt_browserRedLine"><a id="apollo_btn" href="javascript:;" \
		onclick="<% $rm_status eq "done" ? "launch('apollo')" : "" %>" \
		commonname="<% $trimmed_common_name %>" seq_length="<% $proj->sequence_length %>">Apollo</a></span>
		<div style="display: none;" id="apollo_status">loading apollo...</div>
	</span>

	<span id="conRedline_ConColumnR2">
		<span class="bt_browserBlue"><a id="gbrowse_btn" href="javascript:;" onclick="<% $rm_status eq "done" ? "launch('gbrowse', null, 'GBrowse')" : "" %>">Local<br/>Browser</a></span>
% 	if ( $proj->sample) {
		<span class="bt_browserBlueAdd">
			<a id="exporter_btn" href="javascript:;" onclick="<% $rm_status eq "done" ? "launch('exporter',null,'Phytozome Browser')" : "" %>">Phytozome<br/>Browser</a>
		</span>
% 	} else {
		<span class="bt_browserBlueSpacer"></span>
%	}
		<span class="bt_browserYellow"><a href="javascript:;">Phylogenetic<br/>Tree</a></span>
	</span>
</div><!--END of ID conRedlineRight2-->

<!--
<div id="conRunAll">
	<div class="bt_RunAll"><a href="#">RUN<br/> all analysis programs</a></div>
</div>
-->

<div id="conProjectInfo">
	<div id="conProjectInfo_header">
		<div id="conProjectInfo_title">Project Information</div>
                                        <div id="conProjectInfo_projecttitle"><% $proj->name |html%></div>
          								<div id="conProjectInfo_projectlog">Project Log</div>
          							</div>
	

	<span class="conProjectInfo_column1">
		<div class="conProjectInfo_Row">
		<span class="conProjectInfo_Cell1">Project ID</span>
		<span class="conProjectInfo_Cell2">: <% $proj->id %></span>
		</div>
		<div class="conProjectInfo_Row">
		<span class="conProjectInfo_Cell1">User</span>
		<span class="conProjectInfo_Cell2">: <% $user ? $user->full_name : "" |html%></span>
		</div>
		<div class="conProjectInfo_Row">
		<span class="conProjectInfo_Cell1">Affiliation</span>
		<span class="conProjectInfo_Cell2">: DNALC</span>
		</div>
        <div class="conProjectInfo_Row">
             							<span class="conProjectInfo_Cell1">Status</span>
            							<span class="conProjectInfo_Cell3">: &nbsp;<input class="conRadiobox_align" type="radio" name="seq_src" id="seq_src_paste" value="paste"   />&nbsp; Private</span>
                                        <span class="conProjectInfo_Cell3"><input class="conRadiobox_align" type="radio" name="seq_src" id="seq_src_paste" value="paste"   />&nbsp; Public</span>
            						</div>
	</span><!--END of span conProjectInfo_column1-->

	<span class="conProjectInfo_column2">
		<div class="conProjectInfo_Row">
			<span class="conProjectInfo_Cell1">Organism</span>
			<span class="conProjectInfo_Cell2">: <% $proj->common_name %></span>
		</div>
		<div class="conProjectInfo_Row">
			<span class="conProjectInfo_Cell1">Classification</span>
			<span class="conProjectInfo_Cell2">: <% $clades{$proj->clade} %></span>
		</div>
		<div class="conProjectInfo_Row">
			<span class="conProjectInfo_Cell1">Sequence</span>
			<span class="conProjectInfo_Cell3">: <% nicebasepairs($proj->sequence_length) %></span>
			<span class="conProjectInfo_CellBT"><a href="javascript:;" onclick="javascript:launch(null, '<& './.comp/filepath_to_web', file => $pm->fasta_file &>', 'DNA Sequence')">View</a></span>
		</div>
	</span><!--END of span conProjectInfo_column2-->

	 <span class="conProjectInfo_column3">
                                     <div class="conHistorylist">
										<ul >
											<li ><strong>upload_fasta</strong>, 07/24/2009 09:19:39</li>
											<li ><strong>repeat_masker</strong>, 41.070 sec., 07/24/2009 09:21:39</li>
						
										</ul>
                                    <span class="bt_more"><a href="#">More . . .</a></span>
            							
            						</div>
                                    </span>
	</span> <!--END of span conProjectInfo_column3-->
</div><!--END of ID conProjectInfo-->
</div><!--END of ID container_rightContent-->  

%#-------------------------------------------------

<%args>
	$pid => 0
	$debug => 0
</%args>
%#-------------------------------------------------
<%once>
	use Data::Dumper; 
	use DNALC::Pipeline::App::ProjectManager ();
	use DNALC::Pipeline::App::WorkflowManager ();
	use DNALC::Pipeline::App::Utils ();
	use DNALC::Pipeline::User ();
	use DNALC::Pipeline::Utils qw/nicebasepairs/;

	my %routines = (
			'repeat_masker' => 'Repeat Masker',
			'trna_scan' => 'tRNA Scan',
			'augustus' => 'Augustus',
			'fgenesh' => 'FgenesH',
			'snap' => 'Snap',
			'blastn' => 'BlastN',
			'blastx' => 'BlastX',
			'blastn_user' => 'User BlastN',
			'blastx_user' => 'User BlastX',
		);
	my %clades = (
			d => 'Dicotyledons',
			m => 'Monocotyledons',
			u => 'Unknown',
			o => 'Other'
		);
</%once>
%#-------------------------------------------------
<%init>

$m->session->{pipeline} ||= {};
my $s = $m->session->{pipeline};

my $pm = DNALC::Pipeline::App::ProjectManager->new($pid);
my $proj = $pm->project;
unless ($proj) {
	$m->comp('/_message_add', 'Project not found!', 'error');
	$m->redirect('/project/');
}

my $user = DNALC::Pipeline::User->retrieve($proj->user_id);

my %status = ();
my ($history, $rm_status, $trimmed_common_name);
my $wfm = DNALC::Pipeline::App::WorkflowManager->new( $proj );

if ($r->method eq "POST") {
	
	if (!$s->{logged_in} || $s->{user_id} != $proj->user_id) {
		$m->comp('/_message_add', 'Only the owner of the project is allowed to do this!', 'error');
	}
	elsif ($ARGS{evid_nt} || $ARGS{evid_prot}) {
		my $wfm = DNALC::Pipeline::App::WorkflowManager->new( $proj );
		for (qw/evid_nt evid_prot/) {
			if ($ARGS{$_}) {
				my $st = $pm->add_evidence($r, $_);
				if ($st->{status} eq "success") {
					$m->comp("/_message_add", $_ . " evidence added.");
					$wfm->set_status("upload_$_", 'done');
				}
				else {
					$m->comp("/_message_add", 
						$_ . ": error formatting the evidence database." . $st->{message}, 
						"error");
					$wfm->set_status("upload_$_", 'error');
				}
			}
		}
	}
	else {
		$m->comp('/_message_add', 'No evidence added.', 'error');
	}
	$m->redirect('/project/console.html?pid=' . $pid);
}
else { # most likely is GET
	$history = $wfm->get_history;

	for my $rt ( keys %routines ) {
		my $status_name = $wfm->get_status($rt)->name;
		$status{$rt} = $status_name;
		
		#print STDERR "** $rt => $status_name\n";
	}
	$rm_status = $status{repeat_masker};
	$trimmed_common_name = $pm->cleaned_common_name;
}

#print STDERR Dumper( \%status ), $/;

</%init>
%#-------------------------------------------------

%#----------------------------------------------------------------------------
<%def .routine>
<%args>
	$routine => ""
	$rm_status => 'not-processed'
	$status => 'disabled'
	$pmanager => undef
	$delay => 5
</%args>
<%init>
my $link   = 'javascript:;';
my $target = 'target="_blank"';
my $action = qq{onclick="run('$routine')"};
my $title  = '';
my $label  = '';

if ($status eq 'processing') {
	$action = "";
	$target = "";
	$title = $label = 'Processing';
}
elsif ($status eq 'done') {
	my $url = $m->comp('./.comp/filepath_to_web', file => $pmanager->get_gff3_file($routine) || '#', just_return => 1); 
	$action = qq{onclick="launch(null, '$url', '$routines{$routine}')"};
	$target = '';
	$title  = 'Click to view results';
	$label  = 'View';
} 
else {
	if ($rm_status ne 'done' && $routine !~ /trna_scan|repeat_masker/) {
		$status = 'disabled';
		$action = "";
		$title = 'Identify repeats first';
		$label = 'Disabled';
	}
	else {
		if ($status eq 'error') {
			$label = 'Failed/Run';
		}
		else {
			$label = 'Run';
		}
		$title = 'Click to process';
	}
	$target = "";
}
</%init>
<span class="bt_run"><a id="<% $routine %>_btn" href="<% $link %>" class="<% $status %>" <% $target %> \
status="<% $status %>" <% $action %> delay="<% $delay %>" title="<% $title %>" ><% $routines{$routine} %></a>
</span>
</%def>
%#----------------------------------------------------------------------------
<%attr>
	js => ['console.js']
	css => []
	load_window_ui => 1
	current_section => 'red'
</%attr>

%# vim: ft=mason

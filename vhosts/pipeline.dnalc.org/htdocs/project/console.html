
<div id="container_devicebg2"></div>
<div id="container_top">
	<!--<div id="learn_head"><a href="/learnlearn.html" style="padding-left: 10px;">Learn</a></div>
	<div id="logout_head"><a href="home.html" style="padding-left: 10px;">Log Out</a></div>-->
    <div id="backhome"></div>
    <div id="backtoconsole_head">CONSOLE</div>
    <div id="backtoloader_head"><a href="/project/browse">PROJECTS</a></div>
    
</div> <!-- #container_top  -->

<div id="container_content_member3">
<input type="hidden" id="pid" value="<% $pid %>"/>
	<div id="container_pagehead">
		<div id="container_pagetitle">:: CONSOLE ::</div>
		<div id="container_membername">User: Guest</div>
	</div>

	<div id="container_commandertitle"><% $proj->name |html%></div>
	<div id="container_commanderblurb">	
		<& "/_messages" &>
	</div>

	<div id="container_project">
		<div class="commandertitle_member">Project</div>
% if (1) {
<!-- ---------------------------------------- -->
	<div style="height:40px">&nbsp;</div>
<table border="0" cellpadding="1" style="margin-left: 20px;margin-right: auto; width: 278px">
  <tr >
    <td class="tdprojectlabel">User</td>
    <td class="tdprojectinfo">: Guest</td>
</tr>
<tr>
	<td class="tdprojectlabel">Group/Affiliation</td>
    <td class="tdprojectinfo">: DNALC</td>
</tr>
<tr>
	<td class="tdprojectlabel">Project ID</td>
	<td class="tdprojectinfo">: <% $proj->id %></td>
<tr>
  	<td class="tdprojectlabel">Organism</td>
	<td class="tdprojectinfo">: <% $proj->common_name %></td>
</tr>
<tr>
	<td class="tdprojectlabel">Classification</td>
	<td class="tdprojectinfo">: <% $clades{$proj->clade} %></td>
</tr>
<tr>
	<td class="tdprojectlabel" style="vertical-align: top">Sequence size</td>
	<td class="tdprojectinfo"><span style="vertical-align: top">: <% nicebasepairs($proj->sequence_length) %> &nbsp;</span><a href="javascript:;" onclick="launch(null, '<& './.comp/filepath_to_web', file => $pm->fasta_file &>')"><img id="view_seq_btn" src="/images/v0/button_viewDown.png" alt="open sequence" style="border: 0px; margin-top: -3px" /></a></td>
</tr>
</table>
<!--   ----   -->

<div class="historylist"> <!-- history start -->
<div class="tdproject_empty"><img src="/images/v0/dot_blue.png" />&nbsp;History</div>
<ul>
% for my $h (@$history) {
	<li class="closed">
	<strong><% $h->{task_name} %></strong>,\
% if ($h->{duration} > 0) {
	<% $h->{duration}%> sec., 
% }
	<% DNALC::Pipeline::App::Utils->format_datetime($h->{created}) %>
	</li>
% }
</ul>
</div><!-- history end -->
<div id="debug" style="display:<% $debug ? "block" : "none"%>"></div>
% }
</div> <!-- #container_project -->


<div id="container_analyses">
	<div class="commandertitle_member">Analyze</div>
% if (1) {
	<div id="container_analyses1">
		<div class="analysesTexttitle"><img src="/images/v0/dot_blue.png" />&nbsp;<span class="p2">Prepare Sequence</span></div>

        <table width="390" border="0px" cellpadding="1">
		  <tr>
  		    <td class="tdtext">Identify and mask Repetitive DNA &amp; transposons</td>
			<td class="tdinfo">
				<a href="#" class="tt">i<span class="tooltip"><span class="top"></span><span class="middle">Info about this routine will be available soon. Thank you for your patience.</span><span class="bottom"></span></span></a>
			</td>
			<td class="">
				<& '.routine', routine => 'repeat_masker', pmanager => $pm,
								status => $status{repeat_masker}, delay => 15 &>
			</td>
		  </tr>
		</table>

		<div class="analysesTexttitle"></div>
		<div class="analysesTexttitle"><img src="/images/v0/dot_blue.png" />&nbsp;<span class="p2">Predict Genes</span></div>
        <table width="390" border="0px" cellpadding="1">
		   <tr>
			<td class="tdtext">Augustus gene predictor</td>
			<td class="tdinfo"><a href="#" class="tt">i<span class="tooltip"><span class="top"></span><span class="middle">Info about this routine will be available soon. Thank you for your patience.</span><span class="bottom"></span></span></a></td>
			<td class="">
				<& '.routine', routine => 'augustus', pmanager => $pm,
								status => $status{augustus}, delay => 20, rm_status => $rm_status &>
			</td>
		  </tr>
		  <tr>
			<td class="tdtext">FGenesH gene predictor</td>
			<td class="tdinfo"> <a href="#" class="tt">i<span class="tooltip"><span class="top"></span><span class="middle">Info about this routine will be available soon. Thank you for your patience.</span><span class="bottom"></span></span></a></td>
			<td class="" style="border:none">
				<& '.routine', routine => 'fgenesh', pmanager => $pm,
								status => $status{fgenesh}, rm_status => $rm_status &>
		  </tr>

		   <tr>
			<td class="tdtext">SNAP gene predictor</td>
			<td class="tdinfo"><a href="#" class="tt">i<span class="tooltip"><span class="top"></span><span class="middle">Info about this routine will be available soon. Thank you for your patience.</span><span class="bottom"></span></span></a></td>
			<td class="">
				<& '.routine', routine => 'snap', pmanager => $pm,
				status => $status{snap}, rm_status => $rm_status &>
			</td>
		  </tr>
		 <tr>
			<td class="tdtext">tRNA gene predictor</td>
			<td class="tdinfo">
				<a href="#" class="tt">i<span class="tooltip"><span class="top"></span><span class="middle">Info about this routine will be available soon. Thank you for your patience.</span><span class="bottom"></span></span></a>
			</td>
			<td class="">
				<& '.routine', routine => 'trna_scan', pmanager => $pm,
								status => $status{trna_scan}, rm_status => $rm_status &>
			</td>
		  </tr>
		</table>


	<div class="analysesTexttitle"></div>
	<div class="analysesTexttitle"><img src="/images/v0/dot_blue.png" />&nbsp;<span class="p2">Search Databases</span></div>

	<table width="390px" border="0" cellpadding="1">
	  <tr>
		<td class="tdtext">BlastX UniProt for protein homologs</td>
		<td class="tdinfo"><a href="#" class="tt">i<span class="tooltip"><span class="top"></span><span class="middle">Info about this routine will be available soon. Thank you for your patience.</span><span class="bottom"></span></span></a></td>
		<td class="">
					<& '.routine', routine => 'blastx', pmanager => $pm, delay => 15,
					status => $status{blastx}, rm_status => $rm_status &>
		</td>
	  </tr>
	  <tr>
		<td class="tdtext">BlastN UniGene for RNA evidence (cDNA/EST)</td>
		<td class="tdinfo"><a href="#" class="tt">i<span class="tooltip"><span class="top"></span><span class="middle">Info about this routine will be available soon. Thank you for your patience.</span><span class="bottom"></span></span></a></td>
		<td class="">
					<& '.routine', routine => 'blastn', pmanager => $pm, delay => 15,
					status => $status{blastn}, rm_status => $rm_status &>
		</td>
	  </tr>
% my $nt_evid = lc $wfm->get_status("upload_evid_nt")->name;
% my $prot_evid = lc $wfm->get_status("upload_evid_prot")->name;
% if ($nt_evid eq "done") {
	<tr>
		<td class="tdtext">BlastN my evidence</td>
		<td class="tdinfo">&nbsp;</td>
		<td class=""><& '.routine', routine => 'blastn_user', pmanager => $pm, delay => 15,
					status => $status{blastn_user}, rm_status => $rm_status &>
		</td>
	  </tr>
% }
% if ($prot_evid eq "done") {
	  <tr>
		<td class="tdtext">BlastX my evidence</td>
		<td class="tdinfo">&nbsp;</td>
		<td class=""><& '.routine', routine => 'blastx_user', pmanager => $pm, delay => 15,
					status => $status{blastx_user}, rm_status => $rm_status &>
		</td>
	  </tr>
% }
% if ( $nt_evid ne "done" || $prot_evid ne "done") {
	  <tr>
		<td colspan="3">
		<div id="add_evidence" style="display:none; background: pink; text-align: right;">
			<form enctype="multipart/form-data" method="post">
%	if ($nt_evid ne "done") {
				<div>Add Nucleotide based evidence: 
					<input type="file" name="evid_nt" value="xxx" />
				</div>
%	}
%	if ($prot_evid ne "done") {
				<div>Add Proteine based evidence: 
					<input type="file" name="evid_prot" value="" />
				</div>
%	}
		<a id="hide_evidence_link" href="javascript:void(0);" onclick="javascript:$('add_evidence').hide();$('add_evidence_link').show();">cancel</a>
			<input type="submit" value="Upload" />
			</form>
		</div>
		<a id="add_evidence_link" href="javascript:void(0);" onclick="javascript:$('add_evidence').show();$('add_evidence_link').hide();">add evidence</a>
		</td>
	  </tr> 
% }
	</table>

</div> <!-- #container_analyses1 -->
% }
</div> <!-- #container_analyses -->




<div id="container_launch">
	<div class="commandertitle_member">Launch</div>
	<div style="height:40px">&nbsp;</div>

	<div class="container_launch1">
		<div class="launch_gbrowse">
			<a id="gbrowse_btn" class="<% $rm_status ne "done" ? "disabled" : "" %>" \
			onclick="<% $rm_status eq "done" ? q{launch('gbrowse')} : "" %>" \
			href="javascript:;"></a>
		</div>
	</div>    

	<div class="container_launch1">

		<div class="launch_apollo">
			<a id="apollo_btn" class="<% $rm_status ne 'done' ? 'disabled' : '' %>" \
				commonname="<% $trimmed_common_name %>" seq_length="<% $proj->sequence_length %>" \
				onclick="<% $rm_status eq 'done' ? "launch('apollo')" : '' %>" href="javascript:;"></a>
		</div>
		<div id="apollo_status" style="padding-top:10px; height: 40px; display: none; background: yellow;">
			Preparing files. stand by...
		</div>
	</div>

% if ($proj->sample) {
	<div class="container_launch1">
		<div class="launch_exporter">
			<a id="exporter_btn" class="<% $rm_status ne 'done' ? 'disabled' : '' %>" \
				onclick="<% $rm_status eq 'done' ? "launch('exporter')" : '' %>"
				href="javascript:;"></a>
		</div>
	</div>
% }

<!--
<div id="gbrowse" style="display:block"><a href="./prepare_gbrowse?pid=<% $proj->id%>">Browse</a></div>
-->
</div> <!-- #container_launch -->
</div> <!-- #container_content_member3 -->


<%args>
	$pid => 0
	$debug => 0
</%args>
%#-------------------------------------------------
<%once>
	use Data::Dumper; 
	use DNALC::Pipeline::App::ProjectManager ();
	use DNALC::Pipeline::App::WorkflowManager ();
	use DNALC::Pipeline::App::Utils ();
	use DNALC::Pipeline::Utils qw/nicebasepairs/;

	my @routines = (
			{ name => 'trna_scan', label => 'tRNA Scan'},
			{ name => 'augustus', label => 'Augustus', delay => 15},
			{ name => 'fgenesh', 'label' => 'FgenesH'},
			#{ name => 'repeat_masker', label => 'Repeat Masker', delay => 10},
			{ name => 'snap', label => 'Snap'},
			{ name => 'blastn', label => 'BlastN'},
			{ name => 'blastx', label => 'BlastX'},
			{ name => 'blastn_user', label => 'User BlastN'},
			{ name => 'blastx_user', label => 'User BlastX'},
		);
	my %clades = (
			d => 'Eudicotyledons',
			m => 'Monocotyledons',
			u => 'Undefined',
			o => 'Other'
		);
</%once>
%#-------------------------------------------------
<%init>

$m->session->{pipeline} ||= {};
my $s = $m->session->{pipeline};

my $pm = DNALC::Pipeline::App::ProjectManager->new($pid);
my $proj = $pm->project;
unless ($proj) {
	$m->comp('/_message_add', 'Project not found!', 'error');
	$m->redirect('/project/');
}

my %status = ();
my ($history, $rm_status, $trimmed_common_name);
my $wfm = DNALC::Pipeline::App::WorkflowManager->new( $proj );

if ($r->method eq "POST") {

	if ($ARGS{evid_nt} || $ARGS{evid_prot}) {
		my $wfm = DNALC::Pipeline::App::WorkflowManager->new( $proj );
		for (qw/evid_nt evid_prot/) {
			if ($ARGS{$_}) {
				my $st = $pm->add_evidence($r, $_);
				if ($st->{status} eq "success") {
					$m->comp("/_message_add", $_ . " evidence added.");
					$wfm->set_status("upload_$_", 'Done');
				}
				else {
					$m->comp("/_message_add", 
						$_ . ": error formatting the evidence database." . $st->{message}, 
						"error");
					$wfm->set_status("upload_$_", 'Error');
				}
			}
		}
	}
	else {
		$m->comp('/_message_add', 'No evidence added.', 'error');
	}
	$m->redirect('/project/console.html?pid=' . $pid);
}
else { # most likely is GET
	$history = $wfm->get_history;

	for ("repeat_masker", map {$_->{name}} @routines ) {
		my $status_name = lc $wfm->get_status($_)->name;
		$status_name =~ s/\s/-/;
		$status{$_} = $status_name;
	}
	$rm_status = $status{repeat_masker};
	$trimmed_common_name = $pm->cleaned_common_name;
}

#print STDERR Dumper( \%status ), $/;
# TODO : set in session when you're starting to run a routine, 
# and reset this flash after you get info about the execution of the routine
</%init>
%#-------------------------------------------------

%#----------------------------------------------------------------------------
<%def .routine>
<%args>
	$routine => ''
	$rm_status => 'not-processed'
	$status => 'disabled'
	$pmanager => undef
	$delay => 5
</%args>
<%init>
my $link = 'javascript:;';
my $target = 'target="_blank"';
my $action = qq{onclick="run('$routine')"};
my $title  = '';

if ($status eq 'processing') {
	$action = '';
	$target = '';
	$title = 'Processing';
}
elsif ($status eq 'done') {
	my $url = $m->comp('./.comp/filepath_to_web', file => $pmanager->get_gff3_file($routine) || '#', just_return => 1); 
	$action = qq{onclick="launch(null, '$url')"};
	$target = '';
	$title  = 'Click to view results';
} 
else {
	if ($rm_status ne 'done' && $routine !~ /trna_scan|repeat_masker/) {
		$status = 'disabled';
		$action = '';
		$title = 'Identify repeats first';
	}
	else {
		$title = 'Click to process';
	}
	$target = '';
}
</%init>
<a id="<% $routine %>_btn" href="<% $link %>" class="<% $status %>" <% $target %>\
 status="<% $status %>" <% $action %> delay="<% $delay %>" title="<% $title %>" ></a>
</%def>
%#----------------------------------------------------------------------------
<%attr>
	js => ['console.js']
	css => ['device.css']
	load_window_ui => 1
</%attr>

%# vim: ft=mason

<%args>
	$pid => 0
</%args>
<%once>
	use DNALC::Pipeline::App::ProjectManager ();
	use DNALC::Pipeline::Config ();
	use DNALC::Pipeline::Chado::Utils ();
	my $pcf = DNALC::Pipeline::Config->new->cf('PIPELINE');
	use Data::Dumper;
</%once>
<%init>
	$m->session->{pipeline} ||= {};
	my $s = $m->session->{pipeline};

	my $pm = DNALC::Pipeline::App::ProjectManager->new($pid);
	#my $proj = DNALC::Pipeline::Project->retrieve($pid);
	my $proj = $pm->project;
	unless ($proj) {
		$m->comp('/_message_add', 'Project not found!', 'error');
		$m->redirect('/project/');
	}

	# TODO : check project ownership.. ;)

	my $organism = join('_', split /\s+/, $proj->organism). '_' . $proj->common_name;
	my $cutils = DNALC::Pipeline::Chado::Utils->new(
		username => $pm->username,
		organism_string => $organism,
		chado_gbrowse => 'gbrowse_chado.template',
		gbrowse_confdir  => $pcf->{GBROWSE_CONF_DIR},
	);

	# 1st create GBrowse conf file & DB dir for this project
	$cutils->gbrowse_chado_conf($proj->id);

	$m->redirect($pcf->{GBROWSE_URL} . '/' . $pm->username . '_db_' . $proj->id);
</%init>
<%flags>
	inherit => undef
</%flags>

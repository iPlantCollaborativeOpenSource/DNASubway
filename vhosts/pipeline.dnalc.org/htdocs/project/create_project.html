<%args>
	$name => ''
	$seq_src => ''
	$species => ''
	$organism => ''
	$common_name => ''
	$group => ''
	$sequence => ''
</%args>
<%once>
	use DNALC::Pipeline::Config ();
	use DNALC::Pipeline::App::Utils ();
	use DNALC::Pipeline::App::ProjectManager ();
	use DNALC::Pipeline::Utils qw(random_string);
	use Carp;
	use IO::File ();
	use Data::Dumper;
</%once>

<%init>
$m->session->{pipeline} ||= {};
my $s = $m->session->{pipeline};

my $cf = DNALC::Pipeline::Config->new;
my $pcf = $cf->cf('PIPELINE');
my $samples = $pcf->{samples};

my @err = ();

if ($r->method eq 'POST') {

	my $file2process;

	for ($name, $organism, $common_name) {
		$_ =~ s/\s+/ /g;
		$_ =~ s/^\s+//;
		$_ =~ s/\s+$//;
	}

	unless ($name) {
		push @err, "Project name is missing";
	}

	unless ($organism && $common_name) {
		push @err, "Organism name is missing or incorrectly formatted!";
	}
	elsif($organism =~ /[^a-z0-9\s]/i || $common_name =~ /[^a-z0-9\s-]/i) {
		push @err, "Organism name may contain only letters, digits and spaces";
	}

	unless (@err) {
		if ($seq_src eq 'sample') {
			my $samples_dir = $pcf->{samples_dir};
			my ($sample) = grep {$_->{id} == $species} @$samples; 
			if (!$sample || $sample->{organism} ne $organism || $sample->{common_name} ne $common_name) {
				push @err, "Sample organism was not found!";
			} 
			else {
				$file2process = $samples_dir . '/' . $sample->{id} . '/fasta.fa';
			}
		}
		elsif ($seq_src eq 'paste') {
			$file2process = $pcf->{upload_dir} . '/' . random_string(7,7);
			my $in = IO::File->new;
			if ($in->open($file2process, 'w')) {
				print $in $sequence;
				undef $in;
			}
		}
		elsif ($seq_src eq 'upload') {

			my $st = DNALC::Pipeline::App::Utils->save_upload( {
						r => $r, 
						param_name => 'seq_file',
					});

			if ($st->{status} eq 'fail') {
				push @err, "Unable to upload file: ". $st->{message};
			}
			else {
				$file2process = $st->{path};
			}
		}

		my @subnames = split /\s/, $organism;
		unless (2 == @subnames) {
			push @err, "Organism name should contain only two words: genus and species";
		}
		#push @err, "Clade is missing!" unless $group;
	}

	my $pm = DNALC::Pipeline::App::ProjectManager->new;
	my $proj = $pm->search(user_id => $s->{user_id}, name => $name);
	if ($proj) {
		push @err, "You already have a project named [$name]";
	}
	# create the project 
	unless (@err) {
		my $rc = DNALC::Pipeline::App::Utils->process_input_file( $file2process );
		if ($rc->{status} eq 'success') {
			
	 		my $st = $pm->create_project ({                                       
                user_id => $s->{user_id},
                seq => $rc->{seq},
                name => $name,
                organism => $organism,
                common_name => $common_name,
                sample => $species,
                clade => $group,
            });
	    	#print STDERR Dumper( $st ), $/;
			if ($st->{status} eq 'success') {
				print STDERR  "New PID = ", $pm->project, $/;
				$proj = $pm->project;
			}
		}
		else {
			push @err, "Unable to process sequence data!";
			$proj = undef;
		}

		#do some cleaning.. rm any temporary file.. uploaded/pasted..
		if ($seq_src ne 'sample') { 
			# remove temporary file
			print STDERR  "Removing file: ", $file2process, $/;
			unlink $file2process;
		}

		unless ($proj) {
			push @err, "Error creating the project.";
		}
		else {
			print STDERR "project_created: id = ", $proj, ",\tname = ", $proj->name, $/;

			# redirect user to dashboard
			#$m->comp('/_message_add', "Project created successfully!");
			$m->redirect('./console.html?pid=' . $proj->id);
			
		} #end else
	} #end unless
} #end if POST

</%init>

<div id="container_devicebg1"></div>
<div id="container_top">
	<!--<div id="learn_head"><a href="learn.html">&nbsp;Learn</a></div>
	<div id="logout_head"><a href="home.html">&nbsp;Log Out</a></div>-->
	<div id="container_headbackto"></div>
  
</div>
<div id="container_content_member1">
	
 	<div id="container_pagehead">
		<div id="container_pagetitle">:: PROJECTS ::</div>
		<div id="container_membername">User: Guest</div>
	</div>
% if (@err) {
<div style="display:none" id="error_list">
%	foreach (@err) {
<div><% $_ %></div>
%	}
</div>
% }
    <div id="container_projectblurb">
      <p>&nbsp;</p>
    </div>
    
    <div id="container_hometab">
    
     <div class="button_newproject"><img src="/images/v0/bt_newprojectUp.png" alt="" /></div>
     
     <div class="button_publicproject"><a href="/project/browse"></a></div>
    </div><!-- #container_hometab  -->

  <div id="container_memberhomebottom">
  <form id="forma1" enctype="multipart/form-data" method="post">
    <div id="container_newprojectleft">
    
  
<!-- form start -->
  
    <div class="selectortitle_h2">Select Sequence Source</div>
    <div class="spacer"></div>
 <div>
    <input class="selectortitle_h2" type="radio" name="seq_src" id="seq_src_upload" value="upload" onclick="select_source(this)" <% $seq_src eq 'upload' ? 'checked="checked"' : ''%> />
	Upload a Sequence File: (max 100kb) <br/>
		<input class="stylizedupload" type="file" id="seq_file" name="seq_file" \
		onchange="set_source('upload')" onclick="set_source('upload')"  />
 </div>
	<div class="spacer"></div>

	<div><!-- end of enter a sequence -->
		<input type="radio" name="seq_src" id="seq_src_paste" value="paste" <% $seq_src eq 'paste' ? 'checked="checked"' : ''%> /> Enter a Sequence:
		<textarea name="sequence" class="stylized" id="notebox" rows="4" cols="30" onfocus="set_source('paste');"><% $sequence |html %></textarea>
	</div><!-- end of enter a sequence -->
  <br/>
  <div class="spacer"></div>
  <div>
	  <input type="radio" name="seq_src" id="seq_src_sample" value="sample" onclick="select_source(this)" <% $seq_src eq 'sample' ? 'checked="checked"' : ''%> />
		Select a Sample Sequence:
		<select class="stylized" id="specie" name="species" size="6" style="width: 420px;"
				onchange="set_source('sample');">
% for my $sample (@$samples) {
%	my $sel = $seq_src eq 'sample' && $sample->{id} == $species ? 'selected="selected"' : '';
			<option id="o<%$sample->{id}%>" value="<% $sample->{id} %>" \
			extra="location: <% $sample->{location}%>, position: <% $sample->{position}%>, source: <% $sample->{source}%>, release: <%$sample->{release} %>" clade="<% $sample->{clade} ? $sample->{clade} : 'o' %>"\
			<% $sel %>><%$sample->{organism}%> (<%$sample->{common_name}%>) <% $sample->{location} %>, 100 kb</option>
% }
		</select>
   </div>

    </div>
    <!-- #container_newprojectleft -->
    <div id="container_newprojecttopright">
    <div class="selectortitle_h2">Name Your Project</div>
    <div class="spacer"></div>
    
    <label>Project Title:</label>
	<input class="stylized" type="text" name="name" id="name" value="<% $name|html%>" maxlength="128" />
	<div id="organism_info">
		<div class="spacer"></div><br/>
		<div class="selectortitle_h2">&nbsp;&nbsp;Organism</div>
        <div class="spacer"></div>
		<label>Scientific name:<br/><span class="small">(Genus Species)</span></label>
	<input class="stylized" type="text" name="organism" id="organism" value="<% $organism |html%>" maxlength="128" />
	
	<label>Common name:</label>
	<input class="stylized" type="text" name="common_name" id="common_name" value="<% $common_name |html%>" maxlength="128" />
	
	<label>Class:</label>
	<div style="padding-left: 10px;float:left;">
		<input class="resetradio" type="radio" name="group" id="gm" value="m" <% $group eq 'm' ? 'checked="checked"' : ''%>/>
		<span class="small">Monocotyledons</span><br/>
		<input class="resetradio" type="radio" name="group" id="gd" value="d" <% $group eq 'd' ? 'checked="checked"' : ''%>/>
		<span class="small">Dicotyledons</span> <br/> 
		<input class="resetradio" type="radio" name="group" id="go" value="o" <% $group eq 'o' ? 'checked="checked"' : ''%>/>
		<span class="small">Other</span><br/>
		<input class="resetradio" type="radio" name="group" id="gu" value="u" <% $group eq 'u' ? 'checked="checked"' : ''%>/>
		<span class="small">I don't know</span>
	</div>
	</div>
	<div class="spacer"></div>
	<div class="gotoconsole"><a href="javascript:;" onclick="step_one()"></a></div>
</div><!-- #container_newprojecttopright -->
   

<div></div>
   
	</div><!-- #container_newprojectright -->
  </div><!-- #container_memberhomebottom  -->
  </form>
</div>

<%attr>
	js => ['create_project.js']
	css => ['device.css']
	load_window_ui => 1
</%attr>

%# vim: ft=mason

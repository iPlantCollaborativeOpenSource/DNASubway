<%args>
	$name => ''
	$seq_src => ''
	$specie => ''
	$organism => ''
	$common_name => ''
	$group => ''
</%args>
<%once>
	use DNALC::Pipeline::Config ();
	use DNALC::Pipeline::Chado::Utils ();
	use DNALC::Pipeline::App::Utils ();
	use DNALC::Pipeline::Project ();
	use DNALC::Pipeline::App::WorkflowManager ();
	use DNALC::Pipeline::Utils qw(random_string);
	use Carp;
	use Data::Dumper;
</%once>

<%init>
$m->session->{pipeline} ||= {};
my $s = $m->session->{pipeline};

my $cf = DNALC::Pipeline::Config->new;
my $pcf = $cf->cf('PIPELINE');
my $samples = $pcf->{samples};

my @err = ();

if ($r->method eq 'POST') {

	my ($uploaded_file, $sample_file, $seq_crc) = ('', '', '');

	for ($name, $organism, $common_name) {
		$_ =~ s/\s+/ /g;
		$_ =~ s/^\s+//;
		$_ =~ s/\s+$//;
	}

	unless ($name) {
		push @err, "Project Name is missing";
	}

	push @err, "Organism name is missing or incorrectly formatted!" unless $organism && $common_name;

	if (!@err && $seq_src eq 'sample') {
		my $samples_dir = $pcf->{samples_dir};
		my ($sample) = grep {$_->{id} == $specie} @$samples; 
		# checks: organism... group (monocots|dicots)
		if (!$sample || $sample->{organism} ne $organism || $sample->{common_name} ne $common_name) {
			push @err, "Sample organism was not found!!";
		} 
		else {
			$sample_file = $samples_dir . '/' . $sample->{id} . '/fasta.fa';
		}
	}

	if($organism =~ /[^a-z0-9\s]/i || $common_name =~ /[^a-z0-9\s]/i) {
		push @err, "Organism name may contain only letters, digits and spaces";
	}
	my @subnames = split /\s/, $organism;
	unless (2 == @subnames) {
		push @err, "Organism name should contain only two words: genus and specie";
	}
	#push @err, "Group type is missing!" unless $group;

	unless (@err) {
		#fix common_name
		$common_name =~ s/\s+/-/g;

		if ($seq_src eq 'upload') {
			my $st = DNALC::Pipeline::App::Utils->save_upload( {
						r => $r, 
						param_name => 'seq_file',
						common_name => $common_name,
					});

			if ($st->{status} eq 'fail') {
				push @err, "Unable to upload file: ". $st->{message};
			}
			else {
				$uploaded_file = $st->{path};
				$seq_crc = $st->{crc};
			}
			print STDERR 'save_upload status = ', Dumper( $st), $/;
		}
		elsif ($seq_src eq 'sample') {
			my $upl_dir = $pcf->{upload_dir};
			my $rand_s = random_string(8,8);
		    my $output_file = $upl_dir . '/' . $rand_s;

			my ($status, $msg);
			($status, $msg, $seq_crc) = DNALC::Pipeline::App::Utils->process_fasta_file({
						file => $sample_file,
						common_name => $common_name,
						output_file => $output_file,
					});
			if ($status eq 'fail') {
				push @err, $msg;
			}
			$uploaded_file = $output_file;
		}
	}

	my $proj = DNALC::Pipeline::Project->search(user_id => $s->{user_id}, name => $name);
	if ($proj) {
		push @err, "You already have a project named [$name]";
	}
	# create the project 
	unless (@err) {
		print STDERR  'project crc = ', $seq_crc, $/;
		$proj = eval { DNALC::Pipeline::Project->create({
								user_id => $s->{user_id},
								name => $name,
								organism => $organism,
								common_name => $common_name,
								sample => $specie,
								#group => $group,
								crc => $seq_crc || '',
							});
						};
		if ($@) {
			push @err, "Error creating the project: $@";
		}
		else {
			print STDERR "project_created: id = ", $proj, ",\tname = ", $proj->name, $/;

			# create projects work directory
			if ($proj->create_work_dir) {
				print STDERR "project's work_dir: ", $proj->work_dir, $/;
			}
			else {
				warn "Failed to create work_dir for project [$proj]", $/;
				push @err, "Failed to create work_dir for project!";
			}

			unless (-f $uploaded_file) {
				carp "Fasta file is missing:, ", $uploaded_file, $/;
			}
			# set workflow
			my $wfm = DNALC::Pipeline::App::WorkflowManager->new( $proj );
			#print STDERR Dumper( \$wfm), $/;

			# the fasta file may be available not only via upload
			my $fasta = $wfm->upload_sequence($uploaded_file);
			#print STDERR  "Uploaded fasta file = ", $fasta, $/;
			#print STDERR  "upload status = ", $wfm->get_status('upload_fasta'), $/;

			if ($fasta) {
				# remove temporary file
				unlink $uploaded_file;

				# create project files
				my $cutils = DNALC::Pipeline::Chado::Utils->new(
					username => $s->{username},
					dumppath => $pcf->{GMOD_DUMPFILE},
					profile => $pcf->{GMOD_PROFILE},
					organism_string => join('_', @subnames). '_' . $common_name,
					gbrowse_template => $pcf->{GBROWSE_TEMPLATE},
					gbrowse_confdir  => $pcf->{GBROWSE_CONF_DIR},
				);
				if (0) {
					print STDERR  'skipping CHADO insert organism, chado conf file..', $/;
					my $conffile_ok = $cutils->create_conf_file( $proj->id );
					print STDERR "Created file = ", $conffile_ok, $/;
					my $new_profile = sprintf("%s_%d", $s->{username}, $proj->id);
					# read data from new file

					$cutils->profile($new_profile);
					$cutils->insert_organism;
				}

			}

			# redirect user to dashboard
			$m->comp('/_message_add', "Project created successfully!");
			$m->redirect('./dashboard.html?pid=' . $proj->id);
			
		} #end else
	} #end unless
} #end if POST
else {
	#print STDERR  "GET", $/;
	#for ( sort { $a cmp $b } keys %ENV) {
	#	print STDERR  $_, " => ", $ENV{$_}, $/;
	#}
}


</%init>
user = <% $s->{user_id}%>/<% $s->{username} %><br/>
src = <% $seq_src %><br/>
<div id="stylized" class="myform">
<h1>Create new Project</h1>
% if (@err) {
<div class="message error">
%	foreach (@err) {
<div><% $_ %></div>
%	}
</div>
% }
<& /_messages &>
<p>
<h1>Choose the sequence source</h1>
<form id="forma1" enctype="multipart/form-data" method="post">
	<div>
		1. <input type="radio" name="seq_src" id="seq_src_upload" value="upload" onclick="select_source(this)" <% $seq_src eq 'upload' ? 'checked="checked"' : ''%> />
		Upload your sequence file: (max 110kB) 
		<input class="stylized" type="file" id="seq_file" name="seq_file" 
			onchange="set_source('upload')" onclick="set_source('upload')"/>
	</div>
	<div class="spacer" style="font-size:larger">or</div>
	<div>
		2. <input type="radio" name="seq_src" id="seq_src_sample" value="sample" onclick="select_source(this)" <% $seq_src eq 'sample' ? 'checked="checked"' : ''%>/>
		Select from the samples we provide below:
		<div>
			<select class="stylized" id="specie" name="specie" size="4" style="width: 300px;"
				onchange="set_source('sample');">
% for my $sample (@$samples) {
			<option id="o<%$sample->{id}%>" value="<% $sample->{id} %>"><%$sample->{organism}%> (<%$sample->{common_name}%>)</option>
% }
			</select>
		</div>
	<div class="spacer"></div>
	<p></p>
	<label>Project Name	<span class="small">Type your project's name</span></label>
	<input class="stylized" type="text" name="name" id="name" value="<% $name|html%>" />
	<div id="organism_info">
		<label>Organism <span class="small">Scientific name (Genus Specie)</span></label>
		<input class="stylized" type="text" name="organism" id="organism" value="<% $organism |html%>" maxlength="128" />
		<label><span class="small">Common name</span></label>
		<input class="stylized" type="text" name="common_name" id="common_name" value="<% $common_name |html%>" maxlength="128" />
		<div class="spacer"></div>
		<label style="clear:both">Group<span class="small">Monocots or Dicots</span></label>&nbsp;&nbsp;
		<input class="resetradio" type="radio" name="group" id="g1" value="m" /> Monocots
		<input class="resetradio" type="radio" name="group" id="g2" value="d" /> Dicots
		</div>
	</div>
<div class="spacer"></div>

<button type="button" id="continue" onclick="step_one()">Continue</button>
</form>
</p>
</div>

<%attr>
	js => ['create_project.js']
</%attr>

%# vim: ft=mason

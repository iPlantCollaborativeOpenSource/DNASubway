<div id="container_rightContent">

% if (@err) {
<div style="display:none" id="error_list">
%	foreach (@err) {
<div><% $_ %></div>
%	}
</div>
% }

<form id="forma1" enctype="multipart/form-data" method="post">
<div id="conRedlineLeft1"> 
	<div id="conProject_newLeft"> 
		<div class="conNewPro_title">Select Sequence Source *</div> 

		<div class="conNewPro_label">
			<input class="conRadiobox_align" type="radio" name="seq_src" id="seq_src_upload" value="upload" onclick="select_source(this)" <% $seq_src eq "upload" ? "checked=\"checked\"" : ""%>/>&nbsp; 
			Upload a sequence file in <a href="http://en.wikipedia.org/wiki/FASTA_format#Format">FASTA format</a> <small>(max 100kb)</small>:
			<input class="conStylized_box1" type="file" id="seq_file" name="seq_file"  onchange="set_source('upload')" onclick="set_source('upload')"  />
		</div>

		<div class="conNewPro_label">
			<input class="conRadiobox_align" type="radio" name="seq_src" id="seq_src_paste" value="paste" onclick="select_source(this)" <% $seq_src eq "paste" ? "checked=\"checked\"" : ""%> />&nbsp; 
			Enter a sequence in <a href="http://en.wikipedia.org/wiki/FASTA_format#Format">FASTA format</a> <small>(max 100kb)</small>:
			<textarea class="conStylized_box2" name="sequence" id="notebox" rows="5" cols="30" onfocus="set_source('paste');"><% $sequence |html %></textarea>
		</div>

		<div class="conNewPro_label">
			<input class="conRadiobox_align" type="radio" name="seq_src" id="seq_src_sample" value="sample" onclick="select_source(this)" <% $seq_src eq "sample" ? "checked=\"checked\"" : ""%>/>&nbsp; 
		Select a sample sequence:  
			<select class="conStylized_box3" id="specie" name="species" size="6" style="width: 370px;" onchange="set_source('sample');">
% for my $ss (@samples) {
%	my $sel = $seq_src eq "sample" && $ss->id == $species ? "selected=\"selected\"" : "";
			<option id="o<%$ss->id%>" value="<% $ss->id %>" extra="" clade="<% $ss->{clade} ? $ss->{clade} : "o" %>"\
			<% $sel %>><% $ss->organism %> (<% $ss->common_name %>) <% $ss->segment %>, <% nicebasepairs($ss->sequence_length) %></option>
% }
			</select>
		</div>
		<div style="clear: both;">&nbsp;</div>
        <div class="conNewPro_title">Description</div>
        <div class="conNewPro_label">&nbsp;&nbsp;&nbsp;&nbsp; Total characters (max.140): &nbsp;<span id="desc_len"><% length $description %></span></div>
		<div>
			<textarea id="description" name="description" cols="40" class="conStylized_box5" onkeyup="check_description_length(event);"><% $description |html %></textarea>
		</div>
        <div style="clear: both;">&nbsp;</div>
        <div style="clear: both;">&nbsp;</div>
        
	</div>
	  <!--END of ID conProject_newLeft-->
      </div><!--END of ID conRedlineLeft1-->

<div id="conRedlineRight1">

 <div id="conProject_newRight"> 
            	<div class="conNewPro_title">Name Your Project *</div>   
				<div class="conNewPro_label1">
					<label>Project title:</label>
					<input class="conStylized_box4" type="text" name="name" id="name" value="<% $name|html%>" maxlength="40" />
 				</div>
				<div style="clear: both;">&nbsp;</div>
                 <div class="conNewPro_title">Organism *</div>   
            		 <div class="conNewPro_label1">
						<label>Scientific name (genus species):</label>
								<input class="conStylized_box4" type="text" name="organism" id="organism" value="<% $organism |html%>" maxlength="128"  />
 				 </div>  
                 
            		 <div class="conNewPro_label1">
						<label>Common name:</label>
								<input class="conStylized_box4" type="text"name="common_name" id="common_name" value="<% $common_name |html%>" maxlength="128"   />
 				 	</div> 
             <div style="clear: both;">&nbsp;</div> 
				<div class="conNewPro_label1">
					<label>Class:</label>
					<div style="clear: both;">&nbsp;</div>
					<div class="conNewPro_label1">
						<span class="conNewPro_smallContainer">
						<input class="conRadiobox_align" type="radio" name="group" id="gm" value="m" <% $group eq "m" ? "checked=\"checked\"" : ""%>/>&nbsp; Monocotyledons</span>
						<span class="conNewPro_smallContainer">
						<input class="conRadiobox_align" type="radio" name="group" id="gd" value="d" <% $group eq "d" ? "checked=\"checked\"" : ""%>/>&nbsp; Dicotyledons</span>                     
					</div>
					<div class="conNewPro_label1">
						<span class="conNewPro_smallContainer">
						<input class="conRadiobox_align" type="radio" name="group" id="go" value="o" <% $group eq "o" ? "checked=\"checked\"" : ""%>/>&nbsp; Other</span>
						<span class="conNewPro_smallContainer">
						<input class="conRadiobox_align" type="radio" name="group" id="gu" value="u" <% $group eq "u" ? "checked=\"checked\"" : ""%>/>&nbsp; I don't know</span>
					</div>
 				 </div>
				<div style="clear: both;">&nbsp;</div> <div style="clear: both;">&nbsp;</div> 
              <div class="conBT_continue"><a id="step_one_btn" href="javascript:void(0);" onclick="javascript:step_one();"></a></div>
              <div style="clear: both;">&nbsp;</div>
              <div id="con_star"><b>*</b> Required information</div>

            </div><!--END of ID conProject_newRight-->

</div><!--END of ID conRedlineRight1-->
% if ($s->{new_user}) {
<input type="hidden" id="isnew" value="1" />
% }
</form>
</div><!--END of ID container_rightContent-->
%#-----------------------------------------------------------------
<%args>
	$name => ''
	$seq_src => ''
	$species => ''
	$organism => ''
	$common_name => ''
	$group => ''
	$sequence => ''
	$description => ''
</%args>
<%once>
	use DNALC::Pipeline::Utils qw/nicebasepairs random_string/;
	use DNALC::Pipeline::Config ();
	use DNALC::Pipeline::Sample ();
	use DNALC::Pipeline::App::Utils ();
	use DNALC::Pipeline::App::ProjectManager ();
	use DNALC::Pipeline::App::WorkflowManager ();
	use Carp;
	use IO::File ();
	use Data::Dumper;
</%once>

<%init>
$m->session->{pipeline} ||= {};
my $s = $m->session->{pipeline};

my $cf = DNALC::Pipeline::Config->new;
my $pcf = $cf->cf('PIPELINE');

my @samples = DNALC::Pipeline::Sample->search( active => 1, {order_by => "organism, segment, start"});

my @err = ();

if ($r->method eq 'POST') {

	my $file2process;
	my $converted_to_dna = 0;
	my $sequence_id = "";

	for ($name, $organism, $common_name) {
		$_ =~ s/\s+/ /g;
		$_ =~ s/^\s+//;
		$_ =~ s/\s+$//;
	}

	$organism = ucfirst lc $organism;

	unless ($name) {
		push @err, "Project title is missing";
	}

	unless ($organism && $common_name) {
		push @err, "Organism name is missing or incorrectly formatted!";
	}
	elsif($organism =~ /[^a-z0-9\s]/i || $common_name =~ /[^a-z0-9\s-]/i) {
		push @err, "Organism name may contain only letters, digits and spaces";
	}

	if ($seq_src eq "sample" && !defined $sequence) {
		push @err, "Sequence is missing", $/;
	}

	unless (@err) {
		$common_name = lc $common_name;

		if ($seq_src eq "sample") {
			my $sample = DNALC::Pipeline::Sample->new($species);
			if (!$sample) {
				push @err, "Sample organism wasn't found!";
			} 
			else {
				$file2process = $sample->sample_dir . '/fasta.fa';
			}
		}
		elsif ($seq_src eq "paste") {
		
			my $seq = $sequence;
			if (my @ids = ($seq =~ m/^((?:>|;).*)/mg)) {
				$sequence_id = join "\n", @ids;
			}
			$seq =~ s/^(?:>|;).*//mg;
			$seq =~ s/(?:\d|\s)+//g;

			if ($seq =~ /([^actugn]+)/i) {
				push @err, "Sequence contains invalid chars: [". uc ($1) . "]";
			}
			else {
			
				#make it DNA
				if ($seq =~ tr/uU/tT/) {
					$converted_to_dna = 1;
				}

				# make it FASTA
				$seq = "> fasta\n" . $seq;

				$file2process = $pcf->{upload_dir} . '/' . random_string(7,7);
				my $out = IO::File->new;
				if ($out->open($file2process, "w")) {
					print $out $seq;
					undef $out;
				}
			}
		}
		elsif ($seq_src eq "upload") {

			my $st = DNALC::Pipeline::App::Utils->save_upload( {
						r => $r, 
						param_name => 'seq_file',
						clean_sequence => 1,
					});

			if ($st->{status} eq "fail") {
				push @err, "Unable to upload file: ". $st->{message};
			}
			else {
				$file2process = $st->{path};
				$converted_to_dna = $st->{converted_to_dna};
				$sequence_id = $st->{sequence_id};
			}
		}

		my @subnames = split /\s/, $organism;
		unless (2 == @subnames) {
			push @err, "Organism name should contain only two words: genus and species";
		}

		if (length($description) > 140) {
			push @err, "Description should be shorter or equal to 140 characters"
		}
	}

	my ($pm, $proj);
	unless (@err) {
		$pm = DNALC::Pipeline::App::ProjectManager->new;
		my $proj = $pm->search(user_id => $s->{user_id}, name => $name);
		if ($proj) {
			push @err, "You already have a project named [$name]";
		}
		else {
			my $conflicts = $pm->get_organism_conflicts({
					organism => $organism, 
					common_name => $common_name, 
					user_id => $s->{user_id}
				});
			#print STDERR ">>> conflicts: ", Dumper( $conflicts ), $/;
			for (@$conflicts) {
				push @err, "You may use <a href=\"#\" onclick=\"javascript:use_organism(this);\">" 
						. "<em>$_->{organism}, $_->{common_name}</em></a> as organism.";
			}
		}
	}
	# create the project 
	unless (@err) {
		my $rc = DNALC::Pipeline::App::Utils->process_input_file( $file2process );
		#print STDERR Dumper( $rc ), $/;
		if ($rc->{status} eq "success") {
			
	 		my $st = $pm->create_project ({
						user_id => $s->{user_id},
						seq => $rc->{seq},
						name => $name,
						organism => $organism,
						common_name => $common_name,
						sample => $species,
						clade => $group,
						description => $description,
					});
			if ($st->{status} eq 'success') {
				print STDERR  "New PID = ", $pm->project, $/;
				$proj = $pm->project;
			}
		}
		else {
			push @err, "Unable to process sequence data!";
			$proj = undef;
		}

		#do some cleaning.. rm any temporary file.. uploaded/pasted..
		if ($seq_src ne 'sample') { 
			# remove temporary file
			print STDERR  "Removing file: ", $file2process, $/;
			unlink $file2process;
		}

		
		unless ($proj) {
			push @err, "Error creating the project.";
			#$wfm->set_status('upload_fasta', 'error');
		}
		else {
			my $wfm = DNALC::Pipeline::App::WorkflowManager->new( $proj );
			$wfm->set_status('upload_fasta', 'done');
			print STDERR "project_created: id = ", $proj, ",\tname = ", $proj->name, $/;

			if ( $sequence_id ) {
				$pm->log("Saved sequence's id: " . $sequence_id);
			}

			if ($converted_to_dna) {
				$s->{converted_to_dna} = $proj->id;
				$pm->log("RNA converted to DNA.");
			}

			# no longer a new user (it has projects now...)
			delete $s->{new_user} if exists $s->{new_user};

			# redirect user to console
			$m->redirect('./console.html?pid=' . $proj->id);

		} #end else
	} #end unless
} #end if POST

</%init>

%#-----------------------------------------------------------------
<%attr>
	js => ['create_project.js']
	load_window_ui => 1
	current_section => 'red'
</%attr>

%# vim: ft=mason

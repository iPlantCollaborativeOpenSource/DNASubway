<div id="container_rightContent">

% if (@err) {
<div style="display:none" id="error_list">
%	foreach (@err) {
<div><% $_ %></div>
%	}
</div>
% }

<form id="forma1" enctype="multipart/form-data" method="post">
<div id="conRedlineLeft1"> 
	<div id="conProject_newLeft"> 
		<div class="conNewPro_title">Select Sequence Source</div> 

		<div class="conNewPro_label1">
			<input class="conRadiobox_align" type="radio" name="seq_src" id="seq_src_upload" value="upload" onclick="select_source(this)" <% $seq_src eq "upload" ? "checked=\"checked\"" : ""%>/>&nbsp; 
			Upload a Sequence File in <a href="http://en.wikipedia.org/wiki/FASTA_format#Format">FASTA format</a> <small>(max 100kb)</small>:
			<input class="conStylized_box1" type="file" id="seq_file" name="seq_file"  onchange="set_source('upload')" onclick="set_source('upload')"  />
		</div>

		<div style="clear: both;">&nbsp;</div> 
		<div class="conNewPro_label1">
			<input class="conRadiobox_align" type="radio" name="seq_src" id="seq_src_paste" value="paste" <% $seq_src eq "paste" ? "checked=\"checked\"" : ""%> />&nbsp; 
			Enter a Sequence:
			<textarea class="conStylized_box2" name="sequence" id="notebox" rows="5" cols="30" onfocus="set_source('paste');"></textarea>
		</div>

		<div style="clear: both;">&nbsp;</div> 
		<div class="conNewPro_label1">
			<input class="conRadiobox_align" type="radio" name="seq_src" id="seq_src_sample" value="sample" onclick="select_source(this)" <% $seq_src eq "sample" ? "checked=\"checked\"" : ""%>/>&nbsp; 
		Select a Sample Sequence:  
			<select class="conStylized_box3" id="specie" name="species" size="6" style="width: 380px;" onchange="set_source('sample');">
% for my $ss (@samples) {
%	my $sel = $seq_src eq "sample" && $ss->id == $species ? "selected=\"selected\"" : "";
			<option id="o<%$ss->id%>" value="<% $ss->id %>" extra="" clade="<% $ss->{clade} ? $ss->{clade} : "o" %>"\
			<% $sel %>><% $ss->organism %> (<% $ss->common_name %>) <% $ss->segment %>, <% nicebasepairs($ss->sequence_length) %></option>
% }
			</select>
		</div>
	</div>
	  <!--END of ID conProject_newLeft-->

</div><!--END of ID conRedlineLeft1-->

<div id="conRedlineRight1">

 <div id="conProject_newRight"> 
            	<div class="conNewPro_title">Name Your Project</div>   
            		 <div class="conNewPro_label1">
						<label>Project Title:</label>
								<input class="conStylized_box4" type="text" name="name" id="name" value="<% $name|html%>" maxlength="128" />
 				</div>
       		<div style="clear: both;">&nbsp;</div>
                 <div class="conNewPro_title">Organism</div>   
            		 <div class="conNewPro_label1">
						<label>Scientific name (Genus Species):</label>
								<input class="conStylized_box4" type="text" name="organism" id="organism" value="<% $organism |html%>" maxlength="128"  />
 				 </div>  
                 
            		 <div class="conNewPro_label1">
						<label>Common name:</label>
								<input class="conStylized_box4" type="text"name="common_name" id="common_name" value="<% $common_name |html%>" maxlength="128"   />
 				 	</div> 
             <div style="clear: both;">&nbsp;</div> 
				<div class="conNewPro_label1">
					<label>Class:</label>
					<div style="clear: both;">&nbsp;</div>
					<div class="conNewPro_label1">
						<span class="conNewPro_smallContainer">
						<input class="conRadiobox_align" type="radio" name="group" id="gm" value="m" <% $group eq "m" ? "checked=\"checked\"" : ""%>/>&nbsp; Monocotyledons</span>
						<span class="conNewPro_smallContainer">
						<input class="conRadiobox_align" type="radio" name="group" id="gd" value="d" <% $group eq "d" ? "checked=\"checked\"" : ""%>/>&nbsp; Dicotyledons</span>                     
					</div>
					<div class="conNewPro_label1">
						<span class="conNewPro_smallContainer">
						<input class="conRadiobox_align" type="radio" name="group" id="go" value="o" <% $group eq "o" ? "checked=\"checked\"" : ""%>/>&nbsp; Other</span>
						<span class="conNewPro_smallContainer">
						<input class="conRadiobox_align" type="radio" name="group" id="gu" value="u" <% $group eq "u" ? "checked=\"checked\"" : ""%>/>&nbsp; I don't know</span>
					</div>
 				 </div>

                    <div style="clear: both;">&nbsp;
					<!--
                      <div class="conNewPro_label1">
                        <label>Status:</label>
                        <div style="clear: both;">&nbsp;</div>
                        <div class="conNewPro_label1"> <span class="conNewPro_smallContainer">
                          <input class="conRadiobox_align" type="radio" name="group" id="gm2" value="m"   />
                          &nbsp; Private</span> <span class="conNewPro_smallContainer">
                      <input class="conRadiobox_align" type="radio" name="group" id="gm2" value="m"   />
                            &nbsp; Public</span> </div>
                        <div class="conNewPro_label1"></div>
                      </div>
					  -->
                    </div>
              <div class="conBT_continue"><a href="#" onclick="javascript:step_one()"></a></div>
                        
            </div><!--END of ID conProject_newRight-->

</div><!--END of ID conRedlineRight1-->                    
</form>
%#----------------------------------------------------------------------------

% if (0) {
<div></div>
<hr clear="both" />

% if (0) {
<div id="conTop_button"> 
	<div id="conTop_title"><h2>PROJECTS</h2></div>
		<div id="conTop_menu">
			<ul id="conTop_menu">
			<!--<li><a href="#" title="" class="current">New Project</a></li>-->
			<!--<li><a href="#" title="">My Projects</a></li>-->
			<li><a href="./browse" title="">Public Projects</a></li>
			</ul>
		</div>
	<div id="conMember_name">USER: Cornel Ghiban</div>
</div><!--END of ID conTop_button-->
% }

<form id="forma1" enctype="multipart/form-data" method="post">
<!-- Left Content Start -->
<div id="conProject_newLeft">
	<div class="conNewPro_title">Select Sequence Source</div> 
  
	<div class="conNewPro_label1">	
		<input class="conRadiobox_align" type="radio" name="seq_src" id="seq_src_upload" value="upload" onclick="select_source(this)" <% $seq_src eq "upload" ? "checked=\"checked\"" : ""%> />
		Upload a Sequence File in <a href="http://en.wikipedia.org/wiki/FASTA_format#Format">FASTA format</a>: (max 100kb) <br/>
		<input class="conStylized_box1" type="file" id="seq_file" name="seq_file" \
		onchange="set_source('upload');" onclick="set_source('upload')"  />
	</div>

	<div style="clear: both;">&nbsp;</div>
	<div class="conNewPro_label1">
		<input class="conRadiobox_align" type="radio" name="seq_src" id="seq_src_paste" value="paste" <% $seq_src eq "paste" ? "checked=\"checked\"" : ""%> /> 
		Enter a Sequence in <a href="http://en.wikipedia.org/wiki/FASTA_format#Format">FASTA format</a>:
		<textarea name="sequence" class="conStylized_box2" id="notebox" rows="4" cols="30" onfocus="set_source('paste');"><% $sequence |html %></textarea>

	</div>
	<div style="clear: both;">&nbsp;</div>

	<div class="conNewPro_label1">
	  <input class="conRadiobox_align" type="radio" name="seq_src" id="seq_src_sample" value="sample" onclick="select_source(this)" <% $seq_src eq "sample" ? "checked=\"checked\"" : ""%> />
		Select a Sample Sequence:
		<select class="conStylized_box3" id="specie" name="species" size="6" style="width: 420px;"
				onchange="set_source('sample');">
% for my $ss (@samples) {
%	my $sel = $seq_src eq "sample" && $ss->id == $species ? "selected=\"selected\"" : "";
			<option id="o<%$ss->id%>" value="<% $ss->id %>" \
			extra="" clade="<% $ss->{clade} ? $ss->{clade} : "o" %>"\
			<% $sel %>><% $ss->organism %> (<% $ss->common_name %>) <% $ss->segment %>, <% nicebasepairs($ss->sequence_length) %></option>
% }
		</select>
	</div>
</div><!-- #conProject_newLeft -->

<div id="conProject_newRight">
    <div class="conNewPro_title">Name Your Project</div>   
	<div class="conNewPro_label1">
		<label>Project Title:</label>
		<input class="conStylized_box4" type="text" name="name" id="name" value="<% $name|html%>" maxlength="128" />
	</div>

	<div style="clear: both;">&nbsp;</div>
	<div class="conNewPro_title">Organism</div>   
	<div class="conNewPro_label1">
		<label>Scientific name (Genus Species):</label>
		<input class="conStylized_box4" type="text" name="organism" id="organism" value="<% $organism |html%>" maxlength="128"  />
	</div>

	<div class="conNewPro_label1">
	<label>Common name:</label>
		<input class="conStylized_box4" type="text"name="common_name" id="common_name" value="<% $common_name |html%>" maxlength="128"   />
	</div>
	
	<div class="conNewPro_label1">
		<label>Class:</label>
		<div class="conNewPro_label1">
			<span class="conNewPro_smallContainer">
				<input class="conRadiobox_align" type="radio" name="group" id="gm" value="m" <% $group eq "m" ? "checked=\"checked\"" : ""%>/>
				Monocotyledons
			</span>
			<span class="conNewPro_smallContainer">
				<input class="conRadiobox_align" type="radio" name="group" id="gd" value="d" <% $group eq "d" ? "checked=\"checked\"" : ""%>/>
				Dicotyledons
			</span>
		</div>
		<div class="conNewPro_label1">
			<span class="conNewPro_smallContainer">
				<input class="conRadiobox_align" type="radio" name="group" id="go" value="o" <% $group eq "o" ? "checked=\"checked\"" : ""%>/>
				Other
			</span>
			<span class="conNewPro_smallContainer">
				<input class="conRadiobox_align" type="radio" name="group" id="gu" value="u" <% $group eq "u" ? "checked=\"checked\"" : ""%>/>
			I don't know
			</span>
		</div>
	</div>
	<div style="clear: both;">&nbsp;</div>
	<div class="conBT_continue"><a href="#" title="Create project" onclick="javascript:step_one()">CONTINUE</a></div>
</div><!-- #conProject_newRight -->
<div style="clear: both;">&nbsp;</div>
</form>
% }
</div><!--END of ID container_rightContent-->  
%#-----------------------------------------------------------------
<%args>
	$name => ''
	$seq_src => ''
	$species => ''
	$organism => ''
	$common_name => ''
	$group => ''
	$sequence => ''
</%args>
<%once>
	use DNALC::Pipeline::Utils qw/nicebasepairs random_string/;
	use DNALC::Pipeline::Config ();
	use DNALC::Pipeline::Sample ();
	use DNALC::Pipeline::App::Utils ();
	use DNALC::Pipeline::App::ProjectManager ();
	use DNALC::Pipeline::App::WorkflowManager ();
	use Carp;
	use IO::File ();
	use Data::Dumper;
</%once>

<%init>
$m->session->{pipeline} ||= {};
my $s = $m->session->{pipeline};

my $cf = DNALC::Pipeline::Config->new;
my $pcf = $cf->cf('PIPELINE');

# todo: order these by something..
#my @samples = DNALC::Pipeline::Sample->retrieve_all;
my @samples = DNALC::Pipeline::Sample->search( active => 1, {order_by => "organism"});

my @err = ();

if ($r->method eq 'POST') {

	my $file2process;

	for ($name, $organism, $common_name) {
		$_ =~ s/\s+/ /g;
		$_ =~ s/^\s+//;
		$_ =~ s/\s+$//;
	}

	unless ($name) {
		push @err, "Project name is missing";
	}

	unless ($organism && $common_name) {
		push @err, "Organism name is missing or incorrectly formatted!";
	}
	elsif($organism =~ /[^a-z0-9\s]/i || $common_name =~ /[^a-z0-9\s-]/i) {
		push @err, "Organism name may contain only letters, digits and spaces";
	}

	if ($seq_src eq "sample" && !defined $sequence) {
			push @err, "Sequence is missing", $/;
	}

	unless (@err) {
		$common_name = lc $common_name;

		if ($seq_src eq "sample") {
			my $sample = DNALC::Pipeline::Sample->new($species);
			if (!$sample) {
				push @err, "Sample organism wasn't found!";
			} 
			else {
				$file2process = $sample->sample_dir . '/fasta.fa';
			}
		}
		elsif ($seq_src eq "paste") {
		
			$sequence =~ s/^\s+//;
			$sequence =~ s/\s+$//;
			unless ($sequence =~ /^>/) {
				push @err, "The sequence is not in FASTA format.";
			}

			$file2process = $pcf->{upload_dir} . '/' . random_string(7,7);
			my $in = IO::File->new;
			if ($in->open($file2process, "w")) {
				print $in $sequence;
				undef $in;
			}
		}
		elsif ($seq_src eq "upload") {

			my $st = DNALC::Pipeline::App::Utils->save_upload( {
						r => $r, 
						param_name => 'seq_file',
					});

			if ($st->{status} eq "fail") {
				push @err, "Unable to upload file: ". $st->{message};
			}
			else {
				$file2process = $st->{path};
			}
		}

		my @subnames = split /\s/, $organism;
		unless (2 == @subnames) {
			push @err, "Organism name should contain only two words: genus and species";
		}
		#push @err, "Clade is missing!" unless $group;
	}

	my $pm = DNALC::Pipeline::App::ProjectManager->new;
	my $proj = $pm->search(user_id => $s->{user_id}, name => $name);
	if ($proj) {
		push @err, "You already have a project named [$name]";
	}
	else {
		my $organisms = $pm->check_organism({
					organism => $organism, 
					common_name => $common_name, user_id => $s->{user_id}
				});
		for (@$organisms) {
			if ($_->{organism} ne $organism || $_->{common_name} ne $common_name) {
				push @err, "You may use <em>$_->{organism}, $_->{common_name}</em> as organism.";
			}
		}
	}
	# create the project 
	unless (@err) {
		my $rc = DNALC::Pipeline::App::Utils->process_input_file( $file2process );
		if ($rc->{status} eq "success") {
			
	 		my $st = $pm->create_project ({                                       
                user_id => $s->{user_id},
                seq => $rc->{seq},
                name => $name,
                organism => $organism,
                common_name => $common_name,
                sample => $species,
                clade => $group,
            });
	    	#print STDERR Dumper( $st ), $/;
			if ($st->{status} eq 'success') {
				print STDERR  "New PID = ", $pm->project, $/;
				$proj = $pm->project;
			}
		}
		else {
			push @err, "Unable to process sequence data!";
			$proj = undef;
		}

		#do some cleaning.. rm any temporary file.. uploaded/pasted..
		if ($seq_src ne 'sample') { 
			# remove temporary file
			print STDERR  "Removing file: ", $file2process, $/;
			unlink $file2process;
		}

		
		unless ($proj) {
			push @err, "Error creating the project.";
			#$wfm->set_status('upload_fasta', 'error');
		}
		else {
			my $wfm = DNALC::Pipeline::App::WorkflowManager->new( $proj );
			$wfm->set_status('upload_fasta', 'done');
			print STDERR "project_created: id = ", $proj, ",\tname = ", $proj->name, $/;

			# redirect user to console
			#$m->comp('/_message_add', "Project created successfully!");
			$m->redirect('./console.html?pid=' . $proj->id);
			
		} #end else
	} #end unless
} #end if POST

</%init>

%#-----------------------------------------------------------------
<%attr>
	js => ['create_project.js']
	css => ['device.css']
	load_window_ui => 1
	current_section => 'red'
</%attr>

%# vim: ft=mason

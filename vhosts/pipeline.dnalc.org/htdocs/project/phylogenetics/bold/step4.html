<div id="BOLDstep">Step 4 of 6</div>
<div id="BOLDmain">

<h2>Specimen info</h2>
<& /_messages &>
% if (@err) {
	 <div class="errors">
%	for (@err) {
	<div class="error">
		<% $_ |html%>
	</div>
%	}
	</div>
% }
<p>
	<form id="bform" method="POST">
	<input type="hidden" name="bstep" value="4" />

%#---------------------------------
<table border="0" width="600px">
<tbody>
% for my $f (@fields) {
%	my $value = $data->{$f->{id}} || $ARGS{$f->{id}} || "";
%	my $type = $f->{type} || "text";
%	my $style = $f->{display} ? "style=\"display: $f->{display};\"" : "";
%	# make the row visible if [other] value was selected
%	if (my $trigger = $f->{id} and $f->{id} =~ /_o$/) {
%		$trigger =~ s/_o$//;
%		$style = "" if $ARGS{$trigger} ne "" && ($ARGS{$trigger} =~ /other/i || "ARRAY" eq ref $ARGS{$trigger} && grep {/other/i} @{$ARGS{$trigger}});
%	}
	<tr height="28" id="<% $f->{id} %>_tr" <% $style %>>
%	if ($type eq "label") {
	<td colspan="2" class="fb-lbl"><% $f->{label} %>:</td>
% 	} else {
	<td width="200" class="fb-lbl">
%		if ($f->{label}) {
		<label for=""><% $f->{label} %></label>:\
%		}
	</td>
	<td>&nbsp;\
%	if ($type =~ /^(?:text|password)$/) {
		<input class="fb" type="<% $type %>" style="width: 75%" id="<% $f->{id}%>" name="<% $f->{id}%>" value="<% $value |html %>" />\
%	} elsif ($type eq "select") {
		<select id="<% $f->{id}%>" name="<% $f->{id}%>">
		<option value="">=Select=</option>
%		for my $v (@{$f->{values}}) {
%			my $sel = defined $value && $v eq $value ? "selected=\"selected\"" : "";
			<option value="<% $v |html %>" <% $sel %>><% $v|html %></option>\
%		}
		</select>
%	} elsif ($type eq "checkbox") {
%		$value = ref $value ? $value : [$value]; my $idx = 0;
%		for my $v (@{$f->{values}}) {
%			my $chk = (defined $value && grep {/^$v$/} @$value) ? "checked=\"checked\"" : "";
		<span>&nbsp;<input class="fb" type="checkbox" id="<% $f->{id}%>_<% $idx++ %>" name="<% $f->{id}%>" value="<% $v |html %>" <%$chk%>/> <% $v |html%></span>\
%		}
%	} elsif ($type eq "radio") {
%		$value = ref $value ? $value : [$value]; my $idx = 0;
%		for my $v (@{$f->{values}}) {
%			my $chk = (defined $value && grep {/^$v$/} @$value) ? "checked=\"checked\"" : "";
		<span>&nbsp;<input class="fb" type="radio" id="<% $f->{id}%>_<% $idx++ %>" name="<% $f->{id}%>" value="<% $v |html %>" <%$chk%>/> <% $v |html%></span>\
%		}
%	} elsif ($type eq "textarea") {
		<textarea class="fb" rows="5" style="width: 90%" name="<% $f->{id}%>"><% $value |html %></textarea>
%	} elsif ($type eq "component") {
		<& $f->{component}, $f->{id} => $value &>
%	}
%	if ($f->{err}) {
		<strong style="color: red;">*</strong>
%	}
	</td>
%	}
	</tr>
% }

</tbody>
</table>
%#--------------------

	</form>
</p>

</div>
<div id="BOLDfooter">
	<a href="./step3.html">Back</a>&nbsp;
	<a href="#./step5.html" onclick="phy.next_bold_step();">Continue</a>
</div>



<%args>
	$bstep => undef

</%args>

<%once>
	use Email::Valid ();
	use Regexp::Common;
	use DNALC::Pipeline::Utils qw(clean_query);
	use Data::Dumper;
	
	my @fields = (

		{id => "institution_storing", type => "", label => "Institution Storing", re => qr/\w+/, len => 128, },
		{id => "tax", type => "", label => "Identified By", re => qr/\w+/, len => 128, },
		{id => "tax_email", type => "", label => "Identifier's email", re => qr/\w+/, len => 128, },
		{id => "", type => "label", label => "Identification", },
		{id => "phylum", type => "", label => "Phylum", re => qr/\w+/, len => 48, },
		{id => "class", type => "", label => "Class", re => qr/\w+/, len => 48, },
		{id => "order", type => "", label => "Order", re => qr/\w+/, len => 48, },
		{id => "family", type => "", label => "Family", re => qr/\w+/, len => 48, },
		{id => "genus", type => "", label => "Genus", re => qr/\w+/, len => 48, },
		{id => "species", type => "", label => "Species", re => qr/\w+/, len => 48, },
		{id => "collectors", type => "textarea", label => "Collectors", re => qr/\w+/, len => 255, },
		{id => "date_collected", type => "", label => "Date collected (dd/mm/yyyy)", re => qr/^\d\d\/\d\d\/\d{4}$/,},
		#{id => "country", type => "", label => "Country", re => qr/\w+/, len => 128, },
		{id => "country", type => "component", label => "Country", re => qr/\w+/, len => 48,
			component => '../../.comp/countries'},
		{id => "state", type => "component", label => "State/Province", re => qr/\w+/, len => 48,
			component => '../../.comp/_us_states'},
		#{id => "state", type => "", label => "State/Province", re => qr/\w+/, len => 128, },
		{id => "site_desc", type => "", label => "Exact Site", re => qr/\w+/, len => 128, },
		{id => "latitude", type => "", label => "Latitude", re => qr/$RE{num}{real}/, len => 16, },
		{id => "longitude", type => "", label => "Longitude", re => qr/$RE{num}{real}/, len => 16, },
		{id => "notes", type => "textarea", label => "Notes", re => qr/\w*/, len => 255, },
		{id => "sex", type => "radio", label => "Sex of Specimen", values => ['Male', 'Female', 'Hermaphrodite']},
		{id => "stage", type => "radio", label => "Life Stage", re => qr/(?:adult|immature)?/i, len => 8,
			values => ['Adult', 'Immature']},
	);
	
</%once>

<%init>
	my $s = $m->session->{pipeline};
	my $pid = $s->{boldpid};
	$s->{"bold_$pid"} ||= {};
	my $bs = $s->{"bold_$pid"};
	
	print STDERR "S4. PID = ", $pid, Dumper($s), $/;
	
	unless ($bs->{step3} == 1) {
		$m->comp('/_message_add', 'Step 3 is incomplete!', 'error');
		$m->redirect("./step3.html");
	}

	my @err = ();
	
	my $data = {};

	if ($r->method eq "POST") {
		#my $body = "";
		for my $f (@fields) { 
			my $re = $f->{re};
			my $val = $ARGS{$f->{id}};
			$val = $val ? "ARRAY" eq ref $val 
							? join ", ", map {$f->{len} ? substr(clean_query($_), 0, $f->{len}) : clean_query($_)} @$val 
							: $f->{len} ? substr(clean_query($val), 0, $f->{len}) : clean_query($val)
						: "";
			#print STDERR $f->{id}, "\t", $val, $/ if $f->{id};
			if ( defined $re && $val !~ /$re/) {
				push @err, $f->{label} 
						? $f->{message} || $f->{label} . " is missing"
						: $f->{message};
				$f->{err} = 1;
			}
			elsif (my $parent = $f->{id} and $f->{id} =~ /_o$/) {
				$parent =~ s/_o$//;
				if (($ARGS{$parent} =~ /^other$/i || "ARRAY" eq ref $ARGS{$parent} && grep {/other/i} @{$ARGS{$parent}}) 
						&& $val eq ""
				) {
					$f->{err} = 1;
					push @err, $f->{message};
				}

			}
			if ($f->{id} eq "date_collected" && $val ne "") {
				my ($d, $m, $y) = split '/', $val;

				unless ($m > 0 && $m < 13) {
					push @err, "The month must be a number between 1 and 12.";
				}
			}
			if ($f->{id} eq "tax_email" && $val ne "" && !Email::Valid->address($val)) {
				push @err, "Identifier's email is not valid";
				$f->{err} = 1;
			}

			$data->{$f->{id}} = $val if $f->{id};
			$bs->{spec_data}->{$f->{id}} = $val if $f->{id};
		}
		
		unless (@err) {
			$bs->{step4} = 1;
			$m->redirect("./step5.html");
		}
	}
	else {
		$data = $bs->{spec_data} || {};
	}
</%init>
<div class="container_data3">
<div id="container_data_line">&nbsp;</div>
<form method="post">
	<input type="hidden" id="selection_changed" value="" />
	<div class="con_BL_subTitle">
		<input type="checkbox" id="" title="Select all" onchange="$('selection_changed').value='1'" \
		onclick="var chk=this.checked;$$('#seqs input[type=checkbox]').each(function(el) { el.checked = chk});"/> Select all
	</div>
	<div id="seqs" class="seqs">
%# show "init" sources at the top
% for my $source (("init", keys %sequence_groups)) {
%	next unless($sequence_groups{$source});
%	my $source_id = $source;
%	$source_id =~ s/\W+/_/g;
	<fieldset id="f<% $source_id %>">
		<legend>
			<input type="checkbox" id="s<%$source_id%>" onchange="var val=this.checked;$$('#f<% $source_id %> input').each(function(i){i.checked = val;});" />
			<& _buildSourceName, $source &>
		</legend>
%	for (@{$sequence_groups{$source}}) {
	<div style="padding-left: 20px;">
		<input type="checkbox" name="seqids" value="<% $_->{id} %>" id="seq<% $_->{s} %>" \
		<% $selected_sequences{$_->{id}} ? "checked=\"checked\"" : "" %> onchange="$('selection_changed').value='1';"/>
		<span id="seq<% $_->{id} |html %>"><% $_->{name} |html%></span>
	</div>
%	}
		</fieldset>
%	delete $sequence_groups{ $source } if $source eq "init";
% }
	</div>

    
<div class="list_refdata">
	<input type="submit" id="save_selection" value="Save selection" />
	<input type="button" id="close" value="Close" onclick="top.phy.close_window('manage_sequences');"/>
	<input type="hidden" id="pid" value="<% $proj->id %>" />
    </div>
    
    </form>
% if ($ok == 1) {
<script type="text/javascript">
	top.phy.set_status("phy_alignment", "not-processed");
	top.phy.close_window("manage_sequences");
</script>
% }

<div style="clear: both;">&nbsp;</div>
     <div id="container_data_lineBottom">&nbsp;</div>
</div>
</div>
<%args>
	$pid => 0
	@seqids => ()
</%args>
<%once>
	#use File::Slurp qw/read_file/;
	use DNALC::Pipeline::App::Phylogenetics::ProjectManager ();
	use DNALC::Pipeline::Phylogenetics::DataSequence ();
	use DNALC::Pipeline::Phylogenetics::Blast ();
	use DNALC::Pipeline::CacheMemcached ();
	use DNALC::Pipeline::Utils qw/lcs_name/;
	use Data::Dumper;
</%once>
<%init>
	$r->content_type("text/html");
	
	my $ok;
	my @sequences = ();
	my %sequence_groups = ();
	my %selected_sequences = ();
	my %available_sequences = ();

	my $memcached = DNALC::Pipeline::CacheMemcached->new;
	my $pm = DNALC::Pipeline::App::Phylogenetics::ProjectManager->new($pid);
	my $proj = $pm->project;
	unless ($proj) {
		print "Project not found!";
		return;
	}

	for my $pair ($pm->pairs) {
		next unless $pair->consensus;
		my @pair_sequences = $pair->paired_sequences;
		my $name = lcs_name( map {$_->seq->display_id} @pair_sequences);
		$name =~ s/[-_\s]+$//;
		#push @sequences,  { name => "Pair $name", id => "p$pair", source => 'pairs'};
		push @{$sequence_groups{pairs}}, { name => "Pair $name", id => "p$pair", source => 'pairs'};
	}
	# TODO DataSequence->search_non_paired_sequences_with_sources($self->project);
	for my $seq (sort { $a->source_name cmp $b->source_name } $pm->non_paired_sequences) {
		#push @sequences, {name => $seq->display_id, id => $seq->id, source => $seq->source_name};
		push @{$sequence_groups{ $seq->source_name} }, {name => $seq->display_id, id => $seq->id };

		$available_sequences{ $seq->{id} } = 1;
	}
	
	#%available_sequences = map {$_->{id} => 1} @sequences;

	my $mc_key = "selected-seq-$pid";
	
	if ($r->method eq "POST") {
		#print STDERR "seqids: ", Dumper(\@seqids);
		for my $seq_id (@seqids) {
			$selected_sequences{$seq_id} = 1 
				if (exists $available_sequences{$seq_id});
		}
		#print STDERR "selected: ", Dumper(\%selected_sequences);
		$memcached->set($mc_key, [ keys %selected_sequences ]);
		if (keys %selected_sequences) {
			$pm->set_task_status("phy_alignment", "not-processed");
			$ok = 1;
		}
	}
	else {
		# get request
		if ($memcached) {
			my $sel = $memcached->get($mc_key);
			if ($sel && @$sel) {
				%selected_sequences = map {$_ => 1} @$sel;
			}
		}
	}
</%init>
<%def _buildSourceName>
<% $source %>
<%init>
	my $source = $_[0];
	if ($source eq "init") {
		$source = "User data";
	} elsif ($source =~ /^blast:(\d+)$/) {
		$source = "Blast hits";
		#my $blast = DNALC::Pipeline::Phylogenetics::Blast->retrieve($1);
		#if ($blast && $blast->sequence_id) {
		#	my $seq = DNALC::Pipeline::Phylogenetics::DataSequence->retrieve($blast->sequence_id);
		#	$source .= " " . $seq->display_id if $seq;
		#}
	} elsif ($source =~ /^ref:(.+)$/) {
		$source = "Reference data set <strong>$1</strong>";
	}
</%init>
</%def>

<%attr>
	js => ['prototype-1.6.1.js', 'phylogenetics.js']
</%attr>

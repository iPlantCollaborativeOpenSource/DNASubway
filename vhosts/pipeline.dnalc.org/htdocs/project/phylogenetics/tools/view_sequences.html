<style type="text/css">
input.btn { 
	  color: #000; 
	  background:#C2DBF3;
	  margin-right: 2px;
	} 
	
.label{
font: "Arial";
color: #000;
}
</style>

<div class="container_data1">
	<div id="container_data_line">&nbsp;</div>
%	if ($show_trimmed) {
<div id="showing-trimmed-notice" style="font-size:10px;border:#a7cff5 solid 1px;background-color:#f3f7fa;padding:5px;float:left; width: 194px;"><img src="/images/info.png" style="vertical-align: middle;padding-right:7px;" />Your sequences have been trimmed</div>
<div style="clear: both;"></div>
%	}	
	<div id="seqids" class="seqids">
		<pre>
% for (@files) {
%	my $name = $_->file_name; $name =~ s/\..*?$//;
<span id="x<% $_ |html %>"><a href="./view_sequences.html?pid=<% $pid |html%>;fid=<% $_->id %>;show_trimmed=<% $show_trimmed %>"><% $name |html%></a></span>
% }
% for (@sequences) {
<span id="x<% $_->display_id |html %>"><% $_->display_id |html%></span>
% }
</pre>
	</div>
	
	<div id="mini-trace-icons">
		<pre>
% for (@files) {
%	if ($_->has_low_q){
<span id="low_qs_<% $_->id %>"><a href="./view_sequences.html?pid=<% $pid |html%>;fid=<% $_->id %>;show_trimmed=<% $show_trimmed %>"><img src="/images/chart_curve_error.png" border=0 alt="Low Quality Score Alert" style="vertical-align: middle;" /></a></span>
%	}
%	else {
<span><a href="./view_sequences.html?pid=<% $pid |html%>;fid=<% $_->id %>;show_trimmed=<% $show_trimmed %>"><img src="/images/chart_curve.png" border=0 alt="View Trace" title="View Trace" style="vertical-align: middle;" /></a></span>
%	}
% }	
% for (@sequences) {

%}	
</pre>
	</div>
	
	<div id="seqs" class="seqs">
	
% if ($file) {
    <input type="hidden" id="step" value="2" />
	<input type="hidden" id="seq_data" value="<% $file->seq |html%>" />
	<input type="hidden" id="seq_A" value="<% join ",", @{$traces->{A}} %>" />
	<input type="hidden" id="seq_T" value="<% join ",", @{$traces->{T}} %>" />
	<input type="hidden" id="seq_C" value="<% join ",", @{$traces->{C}} %>" />
	<input type="hidden" id="seq_G" value="<% join ",", @{$traces->{G}} %>" />
	<input type="hidden" id="qvalues" value="<% join ",", $file->quality_values %>" />
	<input type="hidden" id="b_locations" value="<% join ",", $file->base_locations %>" />
	<input type="hidden" id="seq_display_id" value="<% $file->file_name %>" />
	<input type="hidden" id="show_trimmed" value="<% $show_trimmed %>" />
%	if ($show_trimmed) {
%	my $seq_obj = $file->seq_object;
	<input type="hidden" id="start" value="<% $seq_obj->start_pos %>" />
	<input type="hidden" id="end" value="<% $seq_obj->end_pos %>" />
% 	}
		<div style="margin-top:17px;margin-left:10px;margin-bottom:20px;border:#000 1px solid;overflow:auto;position:relative;">
			<canvas id="canvas1" height="200">
				Your browser doesn't support this Trace Viewer.
			</canvas>
%	if (!$show_trimmed) {
		<div id="view-seqs-help-bubble" style="position:absolute;z-index:1;left:70px;top:25px;background:url(/images/bt-trace-question.png);display:block;width:21px;height:29px;cursor:pointer" title="What is this line?" onclick="$('view-seqs-help-message').toggle()"></div>
		<!--<div id="view-seqs-help-x-button" style="position:absolute;z-index:1;left:86px;top:22px;background:url(/images/x.png);display:block;width:10px;height:10px;cursor:pointer;" onclick="$('view-seqs-help-message').hide(); $('view-seqs-help-bubble').hide(); $('view-seqs-help-x-button').hide()"></div>-->
		<div id="view-seqs-help-message" style="position:absolute;z-index:1;left:70px;top:52px;background:url(/images/bg-trace-questionPanel.png) no-repeat;display:none;font-size:10px;font-family:arial;color:#2e83ac;text-transform:none;line-height:10px;height:73px;width:250px;padding:10px 15px 10px 15px;">Bars depict quality scores for each nucleotide detected (called). The line marks a quality score of 20; bars below that line indicate low quality calls. <a href='http://en.wikipedia.org/wiki/Phred_quality_score' style="color:#2e83ac;" target="blank">More...</a></div>
% 	}
%	if ($show_trimmed) {
		<div id="view-seqs-help-bubble" style="position:absolute;z-index:1;left:70px;top:25px;background:url(/images/bt-trace-question.png);display:block;width:21px;height:29px;cursor:pointer" title="What is this line?" onclick="$('view-seqs-help-message').toggle()"></div>
		<!--<div id="view-seqs-help-x-button" style="position:absolute;z-index:1;left:86px;top:22px;background:url(/images/x.png);display:block;width:10px;height:10px;cursor:pointer;" onclick="$('view-seqs-help-message').hide(); $('view-seqs-help-bubble').hide(); $('view-seqs-help-x-button').hide()"></div>-->
		<div id="view-seqs-help-message" style="position:absolute;z-index:1;left:70px;top:52px;background:url(/images/bg-trace-questionPanel.png) no-repeat;display:none;font-size:10px;font-family:arial;color:#2e83ac;text-transform:none;line-height:10px;height:73px;width:250px;padding:10px 15px 10px 15px;">Bars depict quality scores for each nucleotide detected (called). The line marks a quality score of 20; bars below that line indicate low quality calls. <a href='http://en.wikipedia.org/wiki/Phred_quality_score' style="color:#2e83ac;" target="blank">More...</a></div>
% 	}
	</div>
%	if ($file->has_low_q){
	<div id="low-qs-alert-link" style="margin-top:-10px; margin-left: 10px; margin-bottom:10px; text-transform:none; background: #c2dbf3; width:195px;">
			<img src="/images/chart_curve_error.png" border=0 alt="Low Quality Score Alert" title="Low Quality Score Alert" style="vertical-align: middle; margin:5px" /><a href="http://en.wikipedia.org/wiki/Phred_quality_score" style="font-size:11px; font-family:'Tahoma'; color:#dd5326;" target="blank" title="The average error rate for this sequence is greater than 1%. This indicates that the sequence is of low quality and may produce erroneous analysis results.">Learn more about quality scores</a><a href="#" onclick="$('low-qs-alert-link').hide();"><img src="/images/x-orange.png" border=0 alt="Close" title="Close" style="vertical-align:top;cursor:pointer;float:right; margin:2px;" /></a>
	</div>
%	}
	<div style="float:left; width: 100px;padding-left:10px;"><input type="button" id="zoom_reset" value=" Reset " onclick="phy.zoomReset()" class="btn" /></div>
	<div style="float:left; width: 200px; text-align: center;">
		<span class="label">X: </span><input type="button" id="x_zoom_in" value="  +  " onclick="phy.zoomIn('x')" class="btn" /><input type="button" id="x_zoom_out" value="  -  " onclick="phy.zoomOut('x')" class="btn" />
	</div>
	<div style="float:left; width: 200px; text-align: right;">
		<span class="label">Y: </span><input type="button" id="y_zoom_in" value="  +  " onclick="phy.zoomIn('y')" class="btn" /><input type="button" id="y_zoom_out" value="  -  " onclick="phy.zoomOut('y')" class="btn"/>
	</div>
%#	<pre><% Dumper($file)%></pre>
% } else {
<input type="hidden" id="step" value="22" />
		<pre>
% unless ($show_trimmed) {
% 	for (@files) {
<span id="<%$_%>" ><% $_->seq|html %></span>
% 	}
% 	for (@sequences) {
<span id="<%$_%>" ><% $_->left_trim|html %><% $_->seq|html %><% $_->right_trim|html %></span>
% 	}
% } else {
% 	for (@files) {
<span id="<%$_%>" ><% $_->seq_object->seq|html %></span>
% 	}
% 	for (@sequences) {
<span id="<%$_%>" ><% $_->seq|html %></span>
% 	}
% }
</pre>
% }
	 </div>
%#     <div style="clear: both;">&nbsp;</div>

	<div style="clear: both;">&nbsp;</div>
     <div id="container_data_lineBottom">&nbsp;</div>
</div> <!-- END of container_rightContent-->

<%args>
	$op => ''
	$data => ''
	$pid => 0
	$fid => 0
	$show_trimmed => 0
</%args>
<%once>
	use File::Slurp qw/read_file/;
	use DNALC::Pipeline::App::Phylogenetics::ProjectManager ();
	use DNALC::Pipeline::Phylogenetics::DataSequence ();
	use DNALC::Pipeline::Config ();
	#use JSON::XS ();
	use Data::Dumper;
</%once>
<%init>
	$r->content_type("text/html");
	my $pairs = undef;
	
	my @sequences = ();
	my ($file, $traces);
	my $display_id;

	my $pm = DNALC::Pipeline::App::Phylogenetics::ProjectManager->new($pid);
	my $proj = $pm->project;
	unless ($proj) {
		#$m->comp('/_message_add', 'Project not found!', 'error');
		#$m->redirect('/project/');
		print "Project not found!";
		return;
	}
	
	my @files = $pm->files("trace");
	if (@files) {
		#@sequences = DNALC::Pipeline::Phylogenetics::DataSequence->search_trace_sequences($pid);
		#print STDERR "trace seq\n";
		if ($fid && $fid =~ /^\d+$/) {
			($file) = grep {$_->id == $fid } @files;
			unless (-f $file->file_path) {
				$file = undef;
			}
			$traces = $file->trace if $file;
		}
	}
	else {
		#@sequences = $pm->sequences;
	}
	@sequences = DNALC::Pipeline::Phylogenetics::DataSequence->search_initial_non_trace_sequences($pid) unless $file;
</%init>
<%attr>
	js => ['prototype-1.6.1.js', 'phylogenetics.js', 'prototip/prototip.js']
	load_ie_canvas => 1
</%attr>


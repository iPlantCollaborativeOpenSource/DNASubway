<div id="container_data_line">&nbsp;</div>
<div id="view-consensus">
% unless ($proj) {
	Error: can't open project "<% $pid|html%>".
% } 
% else {
	<div id="pair-menu">
	<ul>
%	my $cnt = 1;
%	for my $p (@pairs) {
		<li>
			<div class="pair-id-block<% ($cnt == $num ? " active" : "")%>" title="<% $p->name |html%>">
				<a href="./view_consensus?pid=<%$pid |html%>;pair_id=<% $p->id %>;num=<% $cnt %>">Pair <% $cnt++ %><br />
				<small><% $p->name |html%></small></a>
			</div>
		</li>
%	}
	</ul>
	</div>
	<div id="edit-panel">
%	if ($pair) {
		<div id="pair-title-block">
			<div id="pair-title">Pair <% $num %>: <% $pair->name |html%></div>
			<div id="edit-pair-title" style="float:left;padding-right:5px;display:none">Pair <% $num %>: <input type="text" name="pair-name" id="pair-name" value="<% $pair->name |html%>" maxlength="128"/></div>
			<div id="edit-name-link" class="text-links">[<a href="javascript:;" onclick="phy.edit_pair_name();">Edit Name</a>]</div>
			<div id="save-name-link" style="display:none;" class="text-links">[<a href="javascript:;" onclick="phy.save_pair_name($('pair-name').value, <% $num %>, <% $pair %>);">Save</a>] [<a href="javascript:;" onclick="phy.edit_pair_name();">Cancel</a>]</div>
			<div style="clear:both;height:0px">&nbsp;</div>
		</div>
		<div style="clear:both;height:0px">&nbsp;</div>
		<div style="overflow: auto;" class="monospace">
			<div id="labels" style="color:#996600">
				<div id="seq1_name"></div>
				<div id="seq2_name"></div>
				<div id="consensus_div_name"></div>
				<div id="trim-link" class="text-links" style="display:none;">[<a href="javascript:;" onclick="phy.enable_trim();">Trim Consensus</a>]</div>
				<div id="trim-exit-link" style="display:none;" class="text-links">[<a href="javascript:;" onclick="phy.exit_trim();">Exit Trim Mode</a>]</div>
			</div>
			<div id="colons" style="display:none">
				<div>:</div>
				<div>:</div>
				<div>:</div>
			</div>
			<div id="sequences">
				<div id="seq1_div"></div>
				<div id="seq2_div"></div>
				<div id="consensus_div_seq"></div>
			</div>
		</div>
		
		<p><img id="progress" style="padding-left:100px;display:none" src="/images/ajax-loader-2.gif" alt=""></p> 
		<div id="change_base_area" class="monospace"></div>
		<input type="button" id="save_changes_btn" value="Save Changes" onclick="phy.consensus_change()" style="margin-left:5px;display:none;"/>
		<div id="trace_canvas_div" style="display:none; padding:20px;">
			<canvas id="trace_viewer_1" height="210" style="margin-right:10px;border:1px solid grey;">Your browser doesnt support canvas objects.</canvas>
			<canvas id="trace_viewer_2" height="210" style="border:1px solid grey;">&nbsp;</canvas>
		</div>

		<div id="trim-info" style="display:none;">
			<div>
				<div class="trim_total_label">Left Trim: </div>
				<div id="left_trim_value">0</div> bp 
				<span>[<a href="javascript:;" onclick="phy.reset_consensus_trim('l');">Reset</a>]</span>
			</div>
			<div>
				<div class="trim_total_label">Right Trim: </div>
				<div id="right_trim_value">0</div> bp 
				<span>[<a href="javascript:;" onclick="phy.reset_consensus_trim('r');">Reset</a>]</span>
			</div>
			<input type="submit" value="Save Changes" style="margin-top:10px;" onclick="phy.commit_consensus_trim(<% $pair %>);"/>
		</div>
		

		<input type="hidden" id="step" value="5" />		
		<input type="hidden" id="seq1" value="<% $seq1 %>" />
		<input type="hidden" id="seq2" value="<% $seq2 %>" />
		<input type="hidden" id="display_name_1" value="<% $display_name_1 %>" />
		<input type="hidden" id="display_name_2" value="<% $display_name_2 %>" />
		<input type="hidden" id="consensus" value="<% $consensus %>" />
		<input type="hidden" id="pair_id" value="<% $pair->id %>" />
%	}
	</div>
% }
</div>
<div style="clear: both;">&nbsp;</div>
<div id="container_data_lineBottom">&nbsp;</div>


%#----------------------------------------------------------------------------
<%args>
	$pid => 0
	$pair_id => 0
	$num => 1
</%args>
%#----------------------------------------------------------------------------
<%once>
	use DNALC::Pipeline::App::Phylogenetics::ProjectManager ();
	use DNALC::Pipeline::Phylogenetics::Pair ();
	use DNALC::Pipeline::Utils qw/lcs_name/;
	use File::Slurp qw(read_file);
</%once>
%#----------------------------------------------------------------------------
<%init>
	$r->content_type("text/html");
	my ($status, $msg) = ("error", "");
	$pid =~ s/\D+//g;
	my $pm = DNALC::Pipeline::App::Phylogenetics::ProjectManager->new($pid);
	my $proj = $pm->project;
	my @pairs = ();
	my @seqs = ();
	my ($pair) = undef;
	my $seq1;
	my $seq2;
	my $display_name_1;
	my $display_name_2;
	my $consensus; 
	my $alignment;
	my @alignment_line_1;
	my @alignment_line_2;

	unless ($proj) {
		$msg = "Project not found."
	}
	else {
		@pairs = $pm->pairs;
		if ($pair_id) {
			($pair) = grep {$_->id == $pair_id} @pairs;
		}
		else {
			$pair = $pairs[0];
		}
		@seqs = $pair->paired_sequences if $pair;
		$alignment = $pair->alignment if $pair;
		my @aln_lines = sort ((grep {!/^Consensus\s*:/} split('\n', $alignment))[0, 1]);

		#@alignment_line_1 = split(': ', $aln_lines[0]);
		#@alignment_line_2 = split(': ', $aln_lines[1]);
		#@alignment_line_2 =(split(': ',(split('\n', $alignment))[1]));
		#($display_name_1, $seq1) = ($alignment_line_1[0], $alignment_line_1[1]);
		#($display_name_2, $seq2) = ($alignment_line_2[0], $alignment_line_2[1]);
		($display_name_1, $seq1) = split(': ', $aln_lines[0]);
		($display_name_2, $seq2) = split(': ', $aln_lines[1]);
		$consensus = $pair->consensus if $pair;
	}

</%init>
<%attr>
	js => ['prototype-1.6.1.js', 'phylogenetics.js']
	load_ie_canvas => 0
</%attr>
%#----------------------------------------------------------------------------

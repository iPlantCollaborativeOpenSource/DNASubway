<h4><% $display_id |html %></h4>
% if ($blast) {
<div class="tbl">
	<div class="theader">
		<div class="tcell trownum">#</div> 
		<div class="tcell">Name</div>
		<div class="tcell">Details</div>
		<div class="tcell">E</div>
		<div class="tcell">Mismatches</div>
	</div>
%	my $num = 1;
% 	while( my $res = $in->next_result ) {
%		while( my $hit = $res->next_hit ) {
%		  while( my $hsp = $hit->next_hsp ) {
%			my @tmp = split /\s+/, $hit->description;
%#			my $name = join ' ', splice @tmp, 0, 2;
%#			my $desc = $hsp->seq("hit")->display_id . ' - ' . join ' ', splice @tmp, 2;
%			my $name = $hsp->seq("hit")->display_id;
%			$name =~ s/(\.1)?\|$//;
%			my $species = join (' ', splice @tmp, 0, 2);
%			my $desc = join (' ', splice @tmp, 2);
%			my $mismatchcount = $hsp->length('total') - ($hsp->num_conserved + $hsp->gaps('total'));
	<div class="trow">
		<div class="tcell trownum"><% $num %>.<a name="<% $num %>"></a></div> 
		<div class="tcell" id="tip_<% $num %>" desc="<% $hit->description |html %>">\
%#			<input type="checkbox" name="selected_results" id="selected_results" value="<% $name |html%>" />
			<% $name |html%>\
		</div>
		<div class="tcell"><a id="xtip_<% $num %>" href="#<% $num %>" onclick="phy.get_ggl_image(this);"><% $species |html%></a> - <% $desc |html%></div>
		<div class="tcell"><% $hsp->evalue |html%></div>
		<div class="tcell"><% $mismatchcount |html%></div>
	</div>
%			$num++;
%		  }
%		}
% 	}
%	$in_fh->close;
</div>
%#	<div> &nbsp;&nbsp; <a href="javascript:void(0);" onclick="alert('will select all');">Select all</a></div>
%	unless ($dsource) {
<div style="text-align: center;margin: 20px">
	<input type="button" onclick="javascript:phy.add_blast_data('<% $blast->id |html%>')" value="Add blast hits"/>
</div>
<div id="content"></div>
<input type="hidden" id="pid" value="<% $pid |html %>" />
%	}
% }
<input type="hidden" id="step" value="3" />
<script src="https://www.google.com/jsapi?key=ABQIAAAAoSwUiJBqXZvEx46Ti_il-xS7lxesUVAdImlxHuSb_YqL9ZAV0BTy1Vtknu258-haS18HJWNATVZZZg" type="text/javascript"></script>
<script language="Javascript" type="text/javascript">
//<![CDATA[
google.load("search", "1");
//]]>
</script>
%#----------------------------------------------------------------------------
<%args>
	$sid => 0
	$bid => 0
	$pid => 0
</%args>
%#----------------------------------------------------------------------------
<%once>
	use File::Slurp qw/read_file/;
	use DNALC::Pipeline::App::Phylogenetics::ProjectManager ();
	use DNALC::Pipeline::Phylogenetics::DataSequence ();
	use DNALC::Pipeline::Phylogenetics::Pair ();
	use DNALC::Pipeline::Phylogenetics::Blast ();
	use DNALC::Pipeline::Config ();
	use Bio::SearchIO ();
	#use JSON::XS ();
	use IO::Scalar ();
	use Data::Dumper;
</%once>
%#----------------------------------------------------------------------------
<%init>
	$r->content_type("text/html");
	
	my $display_id = "";

	$bid =~ s/\D//g;
	if ($sid =~ /^s/) {
		$sid =~ s/\D//g;
		my $seq = DNALC::Pipeline::Phylogenetics::DataSequence->retrieve($sid);
		$display_id = $seq->display_id;
		#$pid = $seq->project_id;
	}
	elsif ($sid =~ /^p/) {
		$sid =~ s/\D//g;
		my $pair = DNALC::Pipeline::Phylogenetics::Pair->retrieve($sid);
		$display_id = "Pair " . join " + ", map {$_->seq->display_id} $pair->paired_sequences;
		#$pid = $pair->project_id;
	}
	
	my $blast = DNALC::Pipeline::Phylogenetics::Blast->retrieve($bid);
	my ($in_fh, $dsource, $in);
	
	if ($blast) {
		$in_fh = IO::Scalar->new;
		print $in_fh $blast->output;
		$in_fh->seek(0,0);
		
		$dsource = DNALC::Pipeline::Phylogenetics::DataSource
					->search( project_id => $pid, name => "blast:$bid");

		$in = Bio::SearchIO->new(-format => 'blast', -fh => $in_fh);
	}

</%init>
%#----------------------------------------------------------------------------
<%attr>
	js => ['prototype-1.6.1.js', 'phylogenetics.js', 'prototip/prototip.js']
</%attr>

<div class="container_data1">

<& /_messages &>


	<table id="jobs_table">
		<thead>
			<tr>
				<th>#</th>
				<th>File Name</th>
				<th>Basic</th>
				<th>Advanced</th>
				<th>Status</th>
				<th>View Results</th>
			</tr>
		</thead>
		<tbody>
% my $i = 1;
% for my $file (@files) {
%# 32 is the task id for TopHat
%	my $task_id = 32;
%	my @jobs = DNALC::Pipeline::NGS::Job->search_jobs_with_this_input_file($pid, $file, $task_id);
%	my $have_basic_run = grep {$_->is_basic} @jobs;

			<tr class="file" id="file<% $file %>">
				<td><% $i++ %></td>
				<td><% $file->file_name %></td>
				<td><& .run_basic, file => $file, pid => $pid, have_basic_run => $have_basic_run &></td>
				<td>
					<a href="./app_tophat?pid=<% $pid |html%>&fid=<% $file %>" class="text_submit">Run</a>
				</td>
				<td></td>
				<td></td>
			</tr>
			<& .jobs, file => $file, pid => $pid, jobs => \@jobs &>
% }

		</tbody>
	</table>
% if ($launched) {
<script type="text/javascript">
	top.ngs.set_status('ngs_<% $tool |html %>', 'processing');
</script>
% }
% if ($jid) {
	<input type="hidden" id="step" value="3" />
	<input type="hidden" id="jid" value="<% $jid|html %>" />
% }
</div> <!-- end container_data1 --> 
%#-----------------------------------------------------------------
<%def .run_basic>
<%args>
	$file => ''
	$pid => 0
	$have_basic_run => 0
</%args>
<%init>
	return unless ($file);
</%init>
%#		<form method="POST" action="app_tophat">
%#			<input type="hidden" name="basic_run" value="1">
%#			<input type="hidden" name="query1" value="<% $file %>">
%#			<input type="hidden" name="pid" value="<% $pid %>"> 
%#			<input type="submit" value="Run" class="text_submit"> 
%#		</form>
% if (!$have_basic_run) {
		<a onclick="javascript:ngs.basic_run('tophat', <% $pid %>, <% $file %>, this)" href="javascript:;" class="text_submit">Run</a>
% } else {
		<span class="disabled_text_submit">Run</span>
% }

</%def>
%#-----------------------------------------------------------------
<%def .jobs>
<%args>
	$file => ''
	$pid => 0
	$jobs => []
</%args>
<%init>
	return unless ($file && @$jobs);
</%init>
%	for my $job (@$jobs){
		<tr parent="file<% $file %>" id="job-<% $job %>">
			<td></td>
			<td><% $job->attrs->{name} %></td>
			<td></td>
			<td></td>
			<td><% $job->status eq "processing" ? "processing <img src='/images/ajax-loader-2.gif' width='12px;'>" : $job->status %></td>
			<td>
% if ($job->status eq 'done') {
				<a href="./launch_igv?pid=<% $pid %>;jid=<% $job %>"><img src="/images/ngs/icon-igv.png" title="View in IGV" alt="View in IGV" style="border:1px solid grey;width:16px;"/></a>
% }
			</td>
		</tr>
%	}
</%def>
%#-----------------------------------------------------------------
<%args>
	$pid => 0
	$tool => ''
	$launched => ''
	$jid => 0
</%args>
<%once>
	use Data::Dumper;
	use Time::Piece qw/localtime/;
	use DNALC::Pipeline::Utils qw(clean_query);
	use DNALC::Pipeline::App::NGS::ProjectManager ();
	use DNALC::Pipeline::NGS::Job();
	use DNALC::Pipeline::User ();

</%once>
<%init>
	$m->session->{pipeline} ||= {};
	my $s = $m->session->{pipeline};
	my $apif = iPlant::FoundationalAPI->new(
		user => $s->{username},
		token => $s->{api_token},
		debug => 0,
	);
	
	my $pm = DNALC::Pipeline::App::NGS::ProjectManager->new({project => $pid, debug => 0});
	$pm->api_instance($apif) if $apif;
	my $proj = $pm->project;
	
	my $jobs = $pm->get_jobs_by_task('ngs_tophat'); # show non-deleted jobs only
		my $app;
	my $app_cf_file = "NGS_TOPHAT";
	my $st = $pm->app($app_cf_file);

	if ($st->{status} eq "success") {
		$app = $st->{app};
	}
	else {
		print STDERR $st->{status}, " ", $st->{message}, $/;
	}

	my $input_files_only = $app->{conf}->{_input_only_files};
	my $filter = $app->{conf}->{_input_file_filter};
	my @files_all = $input_files_only ? grep {$_->is_input} $pm->data : $pm->data;
	my @files = grep {$_->file_name =~ /$filter/ && !$_->is_local} @files_all if $filter;
</%init>
%#------------------------------------------------------------------------------------

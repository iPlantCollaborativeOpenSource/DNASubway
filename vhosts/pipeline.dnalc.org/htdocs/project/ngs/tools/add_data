
<div id="content" style="padding-left: 20px;">
% if ($files_added) {
<script type="text/javascript">
	top.ngs.close_window('data');
</script>
% } else {
	<div>Listing for path <strong><% $path_to_read %></strong>:</div>
	<div>
	<form id="form_add_data" method="post">
% if ($dir_list && @$dir_list) {
%#		<div><a href="#" onclick="" >select all files</a></div>
	<p>
	<div><a href="/project/ngs/tools/add_data<% $parent_dir %>?pid=<% $pid |html%>">Parent directory</a></div>
%	for my $file ( @$dir_list ){
		<& .display_file_info, file => $file, pid => $pid &>
%	}
	</p>
% }

	<input type="button" id="add" value="Add files" />
	<input type="hidden" id="step" name="step" value="2" />
	<input type="hidden" id="current_path" name="current_path" value="<% $path_to_read |html %>" />
	</form>
	</div>
% }
<pre>
%#	<% Dumper($s) %>
</pre>
<hr />
</div>


<%args>
	$pid => 0
	#$t => ''
	#$action => ''
	$current_path => ''
	@files => ()
</%args>
<%once>
	use DNALC::Pipeline::App::NGS::ProjectManager ();
	use iPlant::FoundationalAPI ();
	use File::Basename qw(basename);
	use Data::Dumper;
</%once>
<%init>
	$r->content_type("text/html");
	$m->session->{pipeline} ||= { username => "", logged_in => 0};
	my $s = $m->session->{pipeline};
	
	my $username = $s->{username};
	my $apif = iPlant::FoundationalAPI->new(
		user => $username,
		token => $s->{api_token},
	);
	my ($path_to_read, $parent_dir, $dir_list, $files_added);
	
	if ($r->method eq "POST") {
		#print STDERR "curr_path: $current_path", $/;
		#print STDERR Dumper(\@files), $/;
		my $pm = DNALC::Pipeline::App::NGS::ProjectManager->new({project => $pid});
		#print STDERR Dumper($pm), $/;
		$files_added = 0;
		if ($pm->project && @files) {
			$pm->api_instance($apif) if $apif;
			for my $file_to_add (@files) {
				my $f = $pm->add_data({
							file_name => basename($file_to_add),
							file_path => $current_path . "/" . $file_to_add,
						},
						{_no_remote_check => 0} # do check if files exist
					);
				$files_added++ if ref($f) =~ //;
			}
		}
		print STDERR "files_added: $files_added", $/;
	}
	else {

		my $browse_path;
		my $path_info = $r->path_info;
		if ($path_info =~ /\/(.*)$/) {
			$browse_path = $1
		}

		if ($browse_path eq "aha") {
			$browse_path = "/shared";
		}

		$path_to_read = $browse_path ? $browse_path : $username;
		$path_to_read = "/" . $path_to_read unless $path_to_read =~ m|^/|;
		#print STDERR "PATH: $path_to_read", $/;
		
		$parent_dir = $path_to_read;
		$parent_dir =~ s|/[^\/]*$||;

		my $io = $apif->io;
		$dir_list = $io->readdir($path_to_read);

	}

</%init>

<%def .display_file_info>
<%args>
	$file => undef
	$pid => 0
</%args>
<%init>
	my ($file_full_path, $fpath);
	$file_full_path = $file->path;

	if ($file->type eq "dir" && $file->name eq ".." ) {
		return;
	}
</%init>
%	if ($file->type eq "dir") {
<div><a href="/project/ngs/tools/add_data<% $file_full_path %>?pid=<% $pid |html%>"><% $file->name %></a></div>
% } else {
<div><input type="checkbox" name="files" value="<% $file->name |html %>" /> &nbsp;<% $file->name %></div>
% }
</%def>
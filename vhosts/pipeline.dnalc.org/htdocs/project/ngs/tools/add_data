% if ($files_added) {
	<script type="text/javascript">
	//top.ngs.close_window('data');
	if (top.ngs.get_status('ngs_tophat') == 'disabled') {
		top.ngs.set_status('ngs_tophat', 'not-processed');
	}
	document.location.replace("/project/ngs/tools/manage_data?pid=<% $pid |html %>");
	</script>
% } else {
	<div class="container_data1">
		<div id="container_data_line_bg">
			<a href="#">< Back</a>
		</div>
	
%	if ($browse_path eq '') {	
		<div style="padding-left:100px;padding-bottom:20px;">
			<span class="label_header" style="padding-right:20px;">Import Data From:</span>
			<input id="sample" name="import_from" type="radio" /><label for="sample" style="padding-right:20px">Sample Data</label>
			<input id="data_store" name="import_from" type="radio" /><label for="data_store">Data Store</label>
		</div>
%	}

% 	if($browse_path ne '') {
		<div>Listing for path <strong><% $path_to_read %></strong>:</div>
%	}
% 	else {
		<div>Select your path:</div>
%	}

		<div style="border-top:1px solid #C2DBF3;border-bottom: 1px solid #C2DBF3;margin:10px 0;">&nbsp;</div>
		
%	if ($browse_path eq '') {
		<div id="folders">
			<div>
				<a href="/project/ngs/tools/add_data/<% $username |html%>?pid=<% $pid |html%>">
					<% $username |html%>
				</a>
			</div>
			<div>
				<a href="/project/ngs/tools/add_data/shared?pid=<% $pid |html%>">
					Shared Data
				</a>
			</div>
		</div>
		<div id="file_folder_divider"></div>
		<div style="clear:both;height:3px;"></div>
		<div id="container_data_lineBottom"></div>
	
%	} else {
	<form id="form_add_data" method="post">
% 		if ($dir_list && @$dir_list) {
		<div id="folders">
			<div class="up">
				<a href="/project/ngs/tools/add_data<% $parent_dir %>?pid=<% $pid |html%>">
					..
				</a>
			</div>
%			for my $file ( @$dir_list ){
%				if ($file->type eq "dir") {	
					<& .display_file_info, file => $file, pid => $pid &>
%				}
%			}
		</div>
		<div id="file_folder_divider"></div>
		<div id="files">
%			for my $file ( @$dir_list ){
%				if ($file->type ne "dir") {	
					<& .display_file_info, file => $file, pid => $pid &>
%				}
%			}
		</div>
		
% 		} else {
		<div>
			<a href="/project/ngs/tools/add_data<% $parent_dir %>?pid=<% $pid |html%>">
				Parent directory
			</a>
		</div>
% 		}
		<div style="clear:both;height:3px;"></div>
		<div id="container_data_lineBottom"></div>
		<p style="text-align:center">
			<input type="button" id="add" value="Add files" />
		</p>
% 	}
	<input type="hidden" id="step" name="step" value="2" />
	<input type="hidden" id="current_path" name="current_path" value="<% $path_to_read |html %>" />
	</form>
% }
	<pre>
%#	<% Dumper($s) %>
	</pre>
	</div>


<%args>
	$pid => 0
	#$t => ''
	#$action => ''
	$current_path => ''
	@files => ()
</%args>
<%once>
	use DNALC::Pipeline::App::NGS::ProjectManager ();
	use iPlant::FoundationalAPI ();
	use File::Basename qw(basename);
	use Data::Dumper;
</%once>
<%init>
	$r->content_type("text/html");
	$m->session->{pipeline} ||= { username => "", logged_in => 0};
	my $s = $m->session->{pipeline};
	
	my $browse_path = "";
			
	my $username = $s->{username};
	my $apif = iPlant::FoundationalAPI->new(
		user => $username,
		token => $s->{api_token},
	);
	my ($path_to_read, $parent_dir, $dir_list, $files_added);
	
	if ($r->method eq "POST") {
		#print STDERR "curr_path: $current_path", $/;
		#print STDERR Dumper(\@files), $/;
		my $pm = DNALC::Pipeline::App::NGS::ProjectManager->new({project => $pid});
		#print STDERR Dumper($pm), $/;
		$files_added = 0;
		if ($pm->project && @files) {
			$pm->api_instance($apif) if $apif;
			for my $file_to_add (@files) {
				my $f = $pm->add_data({
							file_name => basename($file_to_add),
							file_path => $current_path . "/" . $file_to_add,
							is_input => 1,
						},
						{_no_remote_check => 0} # do check if files exist
					);
				$files_added++ if ref($f) =~ //;
			}
		}
		print STDERR "files_added: $files_added", $/;
	}
	else {
		my $path_info = $r->path_info;
		if ($path_info =~ /\/(.*)$/) {
			$browse_path = $1
		}

		
		if ($browse_path) {
			$path_to_read = $browse_path ? $browse_path : $username;
			$path_to_read = "/" . $path_to_read unless $path_to_read =~ m|^/|;
			#print STDERR "PATH: $path_to_read", $/;
			
			$parent_dir = $path_to_read;
			$parent_dir =~ s|/[^\/]*$||;

			my $io = $apif->io;
			$dir_list = $io->readdir($path_to_read);
		}
	}

</%init>

<%def .display_file_info>
<%args>
	$file => undef
	$pid => 0
</%args>
<%init>
	my ($file_full_path, $fpath);
	$file_full_path = $file->path;

	if ($file->type eq "dir" && $file->name eq ".." ) {
		return;
	}
</%init>
%	if ($file->type eq "dir") {
		<div>
			<a href="/project/ngs/tools/add_data<% $file_full_path %>?pid=<% $pid |html%>">
				<% $file->name %>
			</a>
		</div>
% } else {
		<div>
			<input type="checkbox" name="files" value="<% $file->name |html %>" id="<% $file->name |html %>" /><label for="<% $file->name |html %>"><% $file->name %>
		</div>
% }
</%def>

<div id="container_rightContent"> 
<form method="post" id="forma">
<div id="conYellowlineLeft1"> 
	<div id="conProject_newLeft">
	
% if (@err) {
<div style="display:none" id="error_list">
%	foreach (@err) {
	<div><% $_ %></div>
%	}
</div>
% }
	<div class="conNewPro_title">Select Sequence Source</div>
% if (0) {
		<div class="conNewPro_label1">
			<input class="conRadiobox_align" type="radio" name="seq_src" id="seq_src_upload" value="upload" onclick="select_source(this)"  />&nbsp; Upload a Sequence File: (max 100kb) 
			<input class="conStylized_box1" type="file" id="seq_file" name="seq_file"  onchange="set_source('upload')" onclick="set_source('upload')"  />
		</div>
% }
		<div style="clear: both;">&nbsp;</div>
		<div class="conNewPro_label1">
%#			<input class="conRadiobox_align" type="radio" name="seq_src" id="seq_src_paste" value="paste" <% $seq ne "" ? "checked=\"checked\"" : "" %> />&nbsp; 
			Enter a Sequence in FASTA Format: 
			<textarea class="conStylized_box2" name="seq" id="seq" rows="5" cols="30" onfocus="set_source('paste');"><% $seq |html%></textarea>
		</div>
		<div style="clear: both;">&nbsp;</div>
% if (0 && !$seq) {
		<div style="clear: both;">&nbsp;</div>
		<div class="conNewPro_label1">
			<input class="conRadiobox_align" type="radio" name="seq_src" id="seq_src_paste" value="paste"   />&nbsp; Select a Sample Sequence:  
			<select class="conStylized_box3" id="specie" name="species" size="6" onchange="set_source('sample');">
			</select>
		</div>
% }
		<div class="conNewPro_label1">
			<label>Sequence type:</label>
			<div style="padding-left: 100px;">
			<input class="conRadiobox_align" type="radio" name="type" id="type_d" value="d" <% "d" eq $type ? "checked=\"checked\"" : ""%> <% $disable_type ? "disabled=\"disabled\"" : ""%>/> DNA<br/>
			<input class="conRadiobox_align" type="radio" name="type" id="type_p" value="p" <% "p" eq $type ? "checked=\"checked\"": ""%> <% $disable_type ? "disabled=\"disabled\"" : ""%>/> Protein
			</div>
		</div>
	</div><!--END of ID conProject_newLeft-->
</div><!--END of ID conRedlineLeft1-->

<div id="conYellowlineRight1">
	<div id="conProject_newRight"> 
		<div class="conNewPro_title">Name Your Project</div>   
		<div class="conNewPro_label1">
			<label>Project Title:</label>
			<input class="conStylized_box4" type="text" name="name" id="name" value="<% $name|html %>" maxlength="128" />
		</div>
		<div style="clear: both;">&nbsp;</div>
		<div class="conNewPro_title">Organism</div>
		<div class="conNewPro_label1">
			<label>Scientific name (Genus Species):</label>
			<input class="conStylized_box4" type="text" name="organism" id="organism" value="<% $organism |html%>" maxlength="128" />
		</div>
		<div class="conNewPro_label1">
			<label>Common name:</label>
			<input class="conStylized_box4" type="text"name="common_name" id="common_name" value="<% $common_name |html %>" maxlength="128" />
		</div>
		<div style="clear: both;">&nbsp;</div>
		<div class="conNewPro_title">Gene/Protein</div>   
		<div class="conNewPro_label1">
			<label>Name:</label>
			<input class="conStylized_box4" type="text" name="organismx" id="organismx" value="???" maxlength="128"  />
		</div>  
		<div class="conNewPro_label1">
			<label>Class:</label>
			<input class="conStylized_box4" type="text"name="common_name1" id="common_name1" value="???" maxlength="128"   />
		</div> 
		<div class="conNewPro_label1">
			<label>Function:</label>
			<input class="conStylized_box4" type="text"name="common_name2" id="common_name2" value="???" maxlength="128"   />
		</div> 
		<div style="clear: both;">&nbsp;</div>
		<div class="conBT_continue"><a href="javascript:;" onclick="document.forms['forma'].submit()"></a></div>
	</div><!--END of ID conProject_newRight-->
</div><!--END of ID conRedlineRight1-->
                   
</form>
</div><!--END of ID container_rightContent-->

<%args>
	$g => undef
	$organism => ""
	$common_name => ""
	$name => ""
	$type => ""
	$seq => ""
</%args>
<%once>
	use DNALC::Pipeline::App::ProjectManager ();
	use DNALC::Pipeline::TargetGenome ();
	use DNALC::Pipeline::TargetProject ();
	use Bio::SeqIO ();
	use Gearman::Client();
	use DNALC::Pipeline::CacheMemcached ();
	use Data::Dumper;
</%once>
<%init>

$r->content_type("text/html");

$m->session->{pipeline} ||= {};
my $s = $m->session->{pipeline};

my $path_info = $r->path_info;
my ($pid, $start, $stop, $disable_type);

my @err = ();

if ($path_info =~ /_(\d+)\/(\d+)\/(\d+)/) {
	$pid   = $1;
	$start = $2;
	$stop  = $3;
}

my $pm = DNALC::Pipeline::App::ProjectManager->new($pid);
if ($pm->project) {

	if ($r->method eq "GET") {
	
		if (defined $start && $start < 1) {
			$start = 1;
		}

		my $seq_len = $pm->project->sequence_length;
		if (defined $stop && $stop > $seq_len) {
			if ($seq_len > 10_000) {
				$stop = 10_000;
			}
			else {
				$stop = $seq_len;
			}
		}
	
		my $seqio = Bio::SeqIO->new( "-format" => "fasta" , -file => $pm->fasta_file);
		my $seq_obj = $seqio->next_seq();
		$name ||= $pm->cleaned_common_name . ":$start..$stop";
		$seq = ">" . $name . "\n" . $seq_obj->subseq($start,$stop);
		
		$organism ||= $pm->project->organism;
		$common_name ||= $pm->project->common_name;
		$name ||= $pm->cleaned_common_name . ":$start..$stop";
	}
	$type = 'd';
	$disable_type = 1;
}

	if ($r->method eq "POST") {
		unless ($seq) {
			push @err, "Sequence is missing.";
		}
		unless ($name) {
			push @err, "Project title is missing.";
		}
		unless ($organism) {
			push @err, "Organism is missing.";
		}
		unless ($common_name) {
			push @err, "Common name is missing";
		}
		unless ($type) {
			push @err, "Sequence type is missing.";
		}

		unless (@err) {

			my $tp = eval {
					DNALC::Pipeline::TargetProject->create({
						name => $name,
						user_id => $s->{user_id},
						project_id => $pm->project ? $pm->project->id : undef,
						organism => $organism,
						segment => $common_name,
						seq => $seq,
						type => $type,
						status => 'not processed',
					});
				};
			if ($@) {
				print STDERR $@, $/;
				push @err, $@;
			}
			#print STDERR Dumper($s->{target_new_project}), $/;
			# redirect..
			$m->redirect('/project/target/view/' . $tp->id) unless @err;
		}

#-------------------------------------
	if (0) {
		if ($g && "" eq ref $g) {
			$g = [$g];
		}
		if ($g && @$g) {
			my $name = $pm->cleaned_common_name . ":$start..$stop";
			my $tp = eval {
					DNALC::Pipeline::TargetProject->create({
						name => $name,
						project_id => $pm->project->id,
						organism => $pm->project->organism,
						segment => $name,
						seq => $seq,
						type => 'd',
						status => 'processing',
					});
				};
			if ($@) {
				print STDERR $@, $/;
				push @err, $@;
			}

			else {
				print STDERR Dumper($g), $/;
				for my $genome (@$g) {
					$tp->add_to_genomes({
							tpid => $tp,
							genome_id => $genome
						});
				}
				# start the processing
				my $client = Gearman::Client->new;
				my $sx = $client->job_servers(@{$pm->config->{GEARMAN_SERVERS}});
				my $h = $client->dispatch_background( target => $tp->id );
				
				my $md = DNALC::Pipeline::CacheMemcached->new;
				$md->set("target_" . $tp->id . "_status", "processing");

				# redirect..
				$m->redirect('/project/target/');
			}
		} else {
			push @err, 'There was no genome selected.';
		}
	}
#-------------------------------------
	}

	#if ($seq) {
	#	$seq = ">" . $pm->cleaned_common_name . "\n" . $seq;
	#}
	#$genomes = DNALC::Pipeline::TargetGenome->retrieve_all;

</%init>

%#-----------------------------------------------------------------
<%attr>
	current_section => 'yellow'
	js => ['target.js']
	load_window_ui => 1
</%attr>
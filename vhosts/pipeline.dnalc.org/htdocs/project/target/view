<div id="container_rightContent"> 
<div id="conYellowlineLeft2">
<input type="hidden" id="tid" value="<% $tid %>" />
<input type="hidden" id="tstatus" value="<% $tp ? $tp->status : "" %>" />
 <span class="conYellowline_ConColumn1">
	<span class="conYellowline_ConCellTitle">Mosses</span>
%	for (sort {$a->{organism} cmp $b->{organism} } grep {$_->clade =~ /mosses/} @genomes) {
%		my $gid = $_->id;
	<span class="conYellowline_ConCell1"><input class="conRadiobox_align" type="checkbox" name="g" id="g_<% $_->id %>" value="<% $_->id %>" <% (grep {$_ eq $gid } @tp_genomes)  ? "checked=\"checked\"" : "" %> />&nbsp; <% $_->organism %></span>
%	}
	<span class="conYellowline_ConCell1"> &nbsp; </span>
	<span class="conYellowline_ConCellTitle">Algae</span>
%	for (sort {$a->{organism} cmp $b->{organism} } grep {$_->clade =~ /algi/} @genomes) {
%		my $gid = $_->id;
	<span class="conYellowline_ConCell1"><input class="conRadiobox_align" type="checkbox" name="g" id="g_<% $_->id %>" value="<% $_->id %>" <% (grep {$_ eq $gid } @tp_genomes)  ? "checked=\"checked\"" : "" %> />&nbsp; <% $_->organism %></span>
%	}
 </span><!--END of CLASS conYellowline_ConColumn1-->
 <span class="conYellowline_ConColumn1">
	<span class="conYellowline_ConCellTitle">Dicotyledons</span>
%	for (sort {$a->{organism} cmp $b->{organism} } grep {$_->clade =~ /dicotyledones/} @genomes) {
%		my $gid = $_->id;
	<span class="conYellowline_ConCell1"><input class="conRadiobox_align" type="checkbox" name="g" id="g_<% $_->id %>" value="<% $_->id %>" <% (grep {$_ eq $gid } @tp_genomes)  ? "checked=\"checked\"" : "" %>/>&nbsp; <% $_->organism %></span>
%	}
</span><!--END of CLASS conYellowline_ConColumn1-->
<span class="conYellowline_ConColumn1">
	<span class="conYellowline_ConCellTitle">Monocotyledons</span>
%	for (sort {$a->{organism} cmp $b->{organism} } grep {$_->clade =~ /monocotyledones/} @genomes) {
%		my $gid = $_->id;
	<span class="conYellowline_ConCell1"><input class="conRadiobox_align" type="checkbox" name="g" id="g_<% $_->id %>" value="<% $_->id %>" <% (grep {$_ eq $gid } @tp_genomes)  ? "checked=\"checked\"" : "" %> />&nbsp; <% $_->organism %></span>
%	}
 </span><!--END of CLASS conYellowline_ConColumn2-->
</div><!--END of ID conYellowlineLeft2-->

<div id="conYellowlineRight2">
	<span class="bt_browserYellow" id="alignment_span">
%	if (defined $files{fasta}) {
		<applet archive="/files/jalview/jalviewApplet.jar" name="Jalview" 
			codebase="/files/jalview/" 
			code="jalview.bin.JalviewLite"
			height="35" width="110">
%#			<param name="code" value="jalview.bin.JalviewLite">
			<param name="file" value="<% $files{fasta} %>">
			<param name="showAnnotation" value="true">
			<param name="windowHeight" value="500">
			<param name="windowWidth" value="650">
			<param name="showFullId" value="false">
			<param name="label" value="View Alignment">
			<param name="defaultColour" value="Clustal">
			<p id="java_install">To play, <a href="http://java.sun.com/webapps/getjava/BrowserRedirect?host=java.com">install Java now</a>.</p>
		</applet>
%	} else {
	<a href="#">Multiple<br/>Alignment</a>
%	}
	</span>
	<span class="bt_browserYellow"><a href="javascript:;" id="tree_btn" \
% 	if ( $tree_url) {
		onclick="window.open('/files/phylowidget/bare.html?tree=<% $tree_url %>', 'target_tree', 'status=0,height=550,width=650')"
% 	}
	>Phylogenetic<br/>Tree</a></span>
% if ($tree_url && 0) {
	<a href="javascript:;" onclick="launch_tree('<% $tree_url %>')">tree1</a>
	<a href="/files/phylowidget/bare.html?tree=<% $tree_url %>" target="_blank">tree2</a>
	<a href="#" onclick="window.open('/files/phylowidget/bare.html?tree=<% $tree_url %>', 'target_tree', 'status=0,height=600,width=600')">tree3</a>
% }
</div><!--END of ID conYellowlineRight2--> 

<br clear="both"/>
<div id="message" style="color: orange;text-align:right; padding-right: 210px;"><% $message %></div>
% if ($tp) {
<div id="conRun_yellowline">
	<div class="bt_Runyellowline"><a href="javascript:;" style="<% $tp && $tp->status eq "processing" ? "display:none" : "" %>" id="launch_btn" onclick="launch_target()">RUN</a></div>
</div>
% }

<div id="conProjectInfo">
	<div id="conProjectInfo_header">
		<div id="conProjectInfo_title">Project Information</div>
		<div id="conProjectInfo_projecttitle"><% $tp ? $tp->name : "" |html%></div>
		<div id="conProjectInfo_projectlog">Project Log</div>
	</div>

	<span class="conProjectInfo_column1">
		<div class="conProjectInfo_Row">
			<span class="conProjectInfo_Cell1">Project ID</span>
			<span class="conProjectInfo_Cell2">: <% $tp ? $tp->id : "" %></span>
		</div>
		<div class="conProjectInfo_Row">
			<span class="conProjectInfo_Cell1">User</span>
			<span class="conProjectInfo_Cell2">: <% $user_fullname %></span>
		</div>
		<div class="conProjectInfo_Row">
			<span class="conProjectInfo_Cell1">Affiliation</span>
			<span class="conProjectInfo_Cell2">: DNALC</span>
		</div>
		<div class="conProjectInfo_Row">
			<span class="conProjectInfo_Cell1">Sequence</span>
			<span class="conProjectInfo_Cell3">: </span>
			<span class="conProjectInfo_CellBT"><a href="javascript:;" onclick="javascript:launch_viewseq('<% $tid %>')">View</a></span>
		</div>
	</span><!--END of span conProjectInfo_column1-->

	<span class="conProjectInfo_column2">
		<div class="conProjectInfo_Row">
			<span class="conProjectInfo_Cell1">Organism</span>
			<span class="conProjectInfo_Cell2">: <% $tp ? $tp->organism : "" %></span>
		</div>
		<div class="conProjectInfo_Row">
			<span class="conProjectInfo_Cell1"><% $tp && $tp->type eq "p" ? "Protein" : "Gene"%> name</span>
			<span class="conProjectInfo_Cell2">: <% $tp ? $tp->gp_name : "-" %></span>
		</div>
		<div class="conProjectInfo_Row">
			<span class="conProjectInfo_Cell1">Class</span>
			<span class="conProjectInfo_Cell2">: <% $tp ? $tp->class_name : "-" %></span>
		</div>
		<div class="conProjectInfo_Row">
			<span class="conProjectInfo_Cell1">Function</span>
			<span class="conProjectInfo_Cell2">: <% $tp ? $tp->function_name : "-" %></span>
		</div>
	</span><!--END of span conProjectInfo_column2-->
	<span class="conProjectInfo_column2">
		<div class="conProjectInfo_Row"></div>
		<!--
		<div class="conProjectInfo_Row">
			<span class="conProjectInfo_Cell1">Status:</span>
			<span class="conProjectInfo_Cell1x">
				<input class="conRadiobox_align" type="radio" name="xx" id="" value="" />&nbsp; Private
				<input class="conRadiobox_align" type="radio" name="xx" id="" value="" />&nbsp; Public
			</span>
		</div>
		-->
	</span> <!--END of span conProjectInfo_column2-->                   							

</div><!--END of ID conProjectInfo-->  
</div><!--END of ID container_rightContent-->     

<%args>
	$tid => 0
</%args>
<%once>
	use DNALC::Pipeline::TargetGenome ();
	use DNALC::Pipeline::TargetProject ();
	use Data::Dumper;
</%once>
<%init>
	$r->content_type("text/html");

	$m->session->{pipeline} ||= {};
	my $s = $m->session->{pipeline};
	
	my $path_info = $r->path_info;
	my $tree_url = '';
	my @tp_genomes = ();
	my %files;
	
	my $message = '';

	if ($path_info =~ /\/(\d+)$/) {
		$tid = $1;
	}
	my $user_fullname = '';
	my @genomes = DNALC::Pipeline::TargetGenome->retrieve_all;
	my $tp = DNALC::Pipeline::TargetProject->retrieve($tid);
	unless ($tp) {
		$message = "Project not found!";
		$tid = 0;
	}
	else {
		@tp_genomes = map {$_->genome_id->id } $tp->genomes;
		if ($tp->status eq 'done-empty') {
			$message = 'No homologs found. Try searching other genomes.';
		}
		elsif ($tp->status eq 'done') {
			$message = 'Done. Check results.';
			my $workdir = $tp->work_dir;
			for (<$workdir/*>) {
				my $file = $m->comp('../.comp/filepath_to_web', file => $_, just_return => 1);
				if ($file =~ /\.(\w{2,5})$/) {
					$files{$1} = $file;
				}
			}
			if ($files{nw}) {
				#$tree_url = "/files/phylowidget/bare.html?tree='http://<% $r->get_server_name . $files{nw} %>'";
				$tree_url = "http://" . $r->get_server_name . "$files{nw}";
			}
		}
		elsif ($tp->status eq 'processing') {
			$message = 'Processing.';
		}
		elsif ($tp->status eq 'failed') {
			$message = 'Failed to get the results from Target.';
		}
		if ($tp->user_id != $s->{user_id}) {
			my $user = DNALC::Pipeline::User->retrieve($tp->user_id);
			$user_fullname = $user->full_name;
		}
		else {
			$user_fullname = $s->{full_name};
		}
	}

</%init>

%#-----------------------------------------------------------------
<%attr>
	current_section => 'yellow'
	js => ['target.js']
	load_window_ui => 1
</%attr>

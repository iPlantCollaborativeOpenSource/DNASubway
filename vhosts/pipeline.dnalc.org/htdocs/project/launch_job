<%args>
	$t => ''
	$pid => 0
</%args>
%#-------------------------------------------------
<%once>
	use DNALC::Pipeline::Project ();
	use DNALC::Pipeline::Config ();
	use DNALC::Pipeline::App::WorkflowManager ();
	use DNALC::Pipeline::Utils qw(isin);
	use DNALC::Pipeline::CacheMemcached ();
	use Data::Dumper;

	use Gearman::Client ();

	my @routines = qw/trna_scan augustus fgenesh repeat_masker/;
</%once>
%#-------------------------------------------------
<%init>
	$r->content_type('text/plain');

	$m->session->{pipeline} ||= {};
	my $s = $m->session->{pipeline};

	unless ($t) {
		print "{'status':'error', 'message': 'Task unknown.'}";
		return;
	}

	my $mc_key = "status-$t-$pid";
	my $memcached = DNALC::Pipeline::CacheMemcached->new;
	if ($memcached->get($mc_key) eq 'processing') {
		print "{'status':'error', 'message':'Task is being processed.'}";
		return;
	}

	my $proj = DNALC::Pipeline::Project->retrieve($pid);
	unless ($proj) {
		print "{'status':'error', 'message':'Project unknown.'}";
		return;
	}

	if (!$s->{logged_in} || $proj->user_id != $s->{user_id}) {
		print "{'status':'error', 'message':'You are not logged in or this project belongs to another user.'}";
		return;
	}

	my $client = Gearman::Client->new;
	$client->job_servers('127.0.0.1');
	my $h = $client->dispatch_background( $t => $pid);
	if ($h) {
		$memcached->set($mc_key, 'processing');
	}
	#print STDERR  "Launched [$t], h = ", $h, $/;
</%init>
%#-------------------------------------------------
<%flags>
	inherit => undef
</%flags>
%#-------------------------------------------------
% if ($h) {
{'status':'success', 'h':'<% $h %>'}
% } else {
{'status':'error', 'message':'Unable to submit job request.'}
% }
%#-------------------------------------------------
%# vim: ft=mason

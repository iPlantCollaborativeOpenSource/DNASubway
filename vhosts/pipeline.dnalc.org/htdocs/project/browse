
<div id="container_rightContent">
<div id="container_pageTitle"> public projects</div>
<br clear="all"/>
<div id="conProject_tableHolder">
  <table class="conProject_table" summary="">
  <tr>
    <th width="32" scope="col">#</th>
    <th width="76" scope="col">Date</th>
    <th width="200" scope="col">Project Title</th>
	<th width="240" scope="col">Description</th>
    <th width="200" scope="col">Organism</th>
    <th width="120" scope="col">Owner</th>
  </tr>
% for (@projects) {
%	my $created = DNALC::Pipeline::App::Utils->format_datetime($_->created, undef, "%m/%d/%Y");
%	my $color = "#c1272d";
%	my $uri = "/project/console.html?pid=" . $_->id;
%	if ($_->{project_type} eq "target") {
%		$uri = "/project/target/view?tid=" . $_->id;
%		$color = "#fdba3e"; #blue = "#3953A4"
% 	}
<tr>
	<td style="background-color: <% $color %>;"><% $_->id %></td>
	<td><% $created %></td>
	<td><a href="<% $uri %>"><%$_->name |html%></a></td>
	<td><% $_->description |html %></td>
	<td><% $_->organism %>, <% $_->common_name %></td>
	<td><% $_->{full_name} %></td>
	<!--<td><% $_->user_id %></td>-->
</tr>
% }

</table>

<& '/_pager', cur=>$page, pages => $pages, 
	suffix => '', prefix => '/project/browse/' &>

</div>
<div class="clear"> </div>
</div><!--END of ID container_rightContent-->  

%#--------------------------------------------------------
<%args>
	$page => 1
	$sort => 'created desc'
</%args>
<%once>
	use DNALC::Pipeline::MasterProject ();
	use DNALC::Pipeline::Project ();
	use DNALC::Pipeline::TargetProject ();
	use DNALC::Pipeline::User ();
	use DNALC::Pipeline::Config ();
	use DNALC::Pipeline::Utils qw(random_string);
	use DNALC::Pipeline::App::Utils ();
	
	#use Switch 'Perl6';
	
	use Data::Dumper;

	my %clades = (
			d => 'Eudicotyledons',
			m => 'Monocotyledons',
			u => 'Unknown',
			o => 'Other'
		);

	my $epp = 10;
</%once>

<%init>
#my $pcf = DNALC::Pipeline::Config->new->cf('PIPELINE');
$r->content_type('text/html');

$m->session->{pipeline} ||= {};
my $s = $m->session->{pipeline};

if ($r->uri =~ /\/(\d+)$/) {
	$page = $1;
}

unless ($page =~ /^\d+$/) {
	$page = 1;
}

my $pager = DNALC::Pipeline::MasterProject->pager;
$pager->per_page( $epp );
$pager->page( $page );
$pager->order_by( 'mp_id desc' );
$pager->where({ public => 1});

# this should be replaced by a join in DNALC::Pipeline::MasterProject???
#if (0) {
my @projects = grep { defined $_ } map {
				my $pid = $_->project_id;
				my $pclass = 'DNALC::Pipeline::Project';
				if ($_->project_type eq "target") {
					$pclass = 'DNALC::Pipeline::TargetProject';
				}
				my $u = DNALC::Pipeline::User->retrieve($_->user_id);
				my $p = $pclass->retrieve($pid);
				if ($p) {
					$p->{project_type} = $_->project_type;
					$p->{full_name} = $u->full_name if $u;
				}
				$p;
			} $pager->search_where;
#}
#my @projects = $pager->retrieve_all;
#print STDERR Dumper(\@projects);

my $pages = int($pager->total_entries/$epp) + ($pager->total_entries % $epp > 0 ? 1 : 0);

</%init>

%#---------------------------------
<%attr>
	js => []
</%attr>
%#---------------------------------

%# vim: ft=mason

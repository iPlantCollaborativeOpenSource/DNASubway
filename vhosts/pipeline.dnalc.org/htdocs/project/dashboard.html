
<%args>
	$pid => 0
</%args>
%#-------------------------------------------------
<%once>
	use Data::Dumper; 
	use DNALC::Pipeline::Project ();
	use DNALC::Pipeline::App::WorkflowManager ();

	my @routines = (
			{ name => 'augustus', label => 'Augustus', delay => 15},
			{ name => 'fgenesh', 'label' => 'FgenesH'},
			{ name => 'repeat_masker', label => 'Repeat Masker', delay => 10},
			{ name => 'trna_scan', label => 'tRNA Scan'},
		);
</%once>
%#-------------------------------------------------
<%init>

$m->session->{pipeline} ||= {};
my $s = $m->session->{pipeline};

my $proj = DNALC::Pipeline::Project->retrieve($pid);
unless ($proj) {
	$m->comp('/_message_add', 'Project not found!', 'error');
	$m->redirect('/project/');
}

my $wfm = DNALC::Pipeline::App::WorkflowManager->new( $proj );
my $upload_st = $wfm->get_status('upload_fasta');

# TODO : set in session when you're starting to run a routine, 
# and reset this flash after you get info about the execution of the routine
</%init>
%#-------------------------------------------------

<div id="content">
	<& "/_messages" &>
<input type="hidden" id="pid" value="<% $pid %>"/>
<pre>
root dir = <% $r->document_root %>
Project id = <% $pid %>
Project Name: <% $proj->name %>
Fasta file: <% $proj->fasta_file %>
Upload status: <% $upload_st->name %>
Augustus status: <% $wfm->get_status('augustus')->name %>
FGenesH status: <% $wfm->get_status('fgenesh')->name %>
Repeat Masker status: <% $wfm->get_status('repeat_masker')->name %>
TRN Scan status: <% $wfm->get_status('trna_scan')->name %>
</pre>
<ul>
%	for my $rt (@routines) {
%		my $rname = $rt->{name};
	<li><span style="font-weight:bold"><% $rt->{label} %></span>&nbsp;
		<input type="button" id="<% $rname %>_btn" value="Run" onclick="run('<% $rname %>')"/>
		<span class="loading" id="<% $rname %>" delay="<% $rt->{delay} || 3 %>">
%	if ($wfm->get_status($rname)->name eq 'Done') {
%		my $path = $m->comp('./.comp/filepath_to_web', file => $proj->get_gff3_file($rname) || '', just_return => 1);
%		if ($path) {
			<a target="_blank" href="<% $path %>">View output</a>
%		}
%	}
		</span>
	</li>
%	}

</ul>
<div id="debug"></div>

</div>


<%attr>
	js => ['dashboard2.js']
</%attr>

%# vim: ft=mason

<div style="width: 60%; margin-left: 100px;">

<h2>Reset your password</h2>
<p>&nbsp;</p>

% if (@err) {
<div class="error" style="color: red; ">
%	for (@err) {
		<div><% $_ %></div>
%	}
</div>
%}

% unless ($sc) {
<form method="post">
	<table style="width: 400px;">
	<tr>
		<td style="width: 30%">Code:</td>
		<td><input type="text" name="c" value="<% $c |html%>" /></td>
	</tr>
	<tr>
		<td>Password:</td>
		<td><input type="password" name="p" value="<% $p |html%>" /></td>
	</tr>
	<tr>
		<td>Re-enter password:</td>
		<td><input type="password" name="p2" value="<% $p2 |html%>" /></td>
	</tr>
	<tr>
		<td>&nbsp;</td>
		<td><input type="submit" name="submit" value="Set password" /></td>
	</tr>
	</table>
</form>
% } elsif ($sc == 1) {
	<p><strong>You have successfully changed your password.</strong></p>
	<a href="/">DNA Subway</a> Team.
% }
</div>
<%args>
	$c => ''
	$p => ''
	$p2 => ''
	$sc => undef
</%args>
%#-------------------------------------------------------------------
<%once>
	use DNALC::Pipeline::User ();
	use Data::Dumper;
</%once>
%#-------------------------------------------------------------------
<%init>
	my @err = ();
	my ($u);

	if ($c) {
		if ('ARRAY' eq ref($c)) {
			$c = $c->[1];
		}
		$u = DNALC::Pipeline::User->get_user_by_reset_pwd_code($c);
		if (!$u) {
			push @err, 'Invalide code!';
		}
	}
	
	if ($r->method eq "POST") {
		if ($u) {
			unless (defined $p && length ($p) >= 5) {
				push @err, "Password is too short. Use minimum 5 chars.";
			}
			unless (defined $p2 && $p2 eq $p) {
				push @err, "Passwords do not match.";
			}
			unless (@err) {
				print STDERR "[$p] =?= [$p2]", $/;
				$u->password($p);
				$u->crypt_password();
				$u->update;
				
				$u->clear_reset_pwd_code;
				$m->redirect('/resetpass.html?sc=1');
			}
		}
	}
</%init>
%#-------------------------------------------------------------------

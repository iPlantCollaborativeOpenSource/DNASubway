<div style="width: 80%;">

% if ($faction ne 'reload' && @err) {
<div class="error" style="color: red; ">
%	for (@err) {
		<div><% $_ %></div>
%	}
</div>
%}

<form id="form_reg" method="post">
<input type="hidden" name="faction" id="faction" value="" />
	<table class="register-table">
%	if (0) {
		<tr>
			<td class="label">Title:</td>
			<td><select name="title" id="title" class="conStylized_box4"/>
		<option value="">Title</option>
%	for ( @titles ) {
%		my $sel = lc $_ eq $s->{title} ? " selected=\"selected\"" : "";
	<option value="<% lc $_ %>"<% $sel %>><% $_ %></option>
%	}
			</select></td>
		</tr>
%	}
%	for (@$fields) {
%		my $type = defined $_->{type} ? $_->{type}  : 'text';
		<tr>
			<td class="label"><% $_->{label} %>:</td>
			<td><input class="conStylized_box4" type="<% $type %>" name="<% $_->{id} %>" value="<% $s->{$_->{id}} |html%>" maxlength="<% $_->{maxlength} %>"/></td>
		</tr>
%	}
		<tr>
			<td colspan="2">&nbsp;</td>
		</tr>
		<tr>
			<td class="label">Country:</td>
			<td><& project/.comp/countries, country => $s->{country}, class => "conStylized_box4" &></td>
		</tr>
		<tr>
			<td class="label">Zip code:</td>
			<td><input class="conStylized_box4" type="text" name="zip" value="<% $s->{zip} |html%>" maxlength="10"/></td>
		</tr>
<& "./_user_profile", parent => $tree_root, questions => $questions, answers => $s &>
	</table>
	<div style="text-align: center"><input type="submit" name="fsubmit" value="Register" /></div>
</form>
</div>

%#-------------------------------------------------------------------
<%args>
	$title => ''
	$gender => ''
	$country => ''
	$zip => ''
	$degree => ''
	$degree_details => ''
	$occupation => ''
	$ethnicity => ''
	$faction => ''
</%args>
%#-------------------------------------------------------------------
<%once>
	use DNALC::Pipeline::Utils qw/random_string/;
	use DNALC::Pipeline::Config ();
	use DNALC::Pipeline::Chado::Utils ();
	use DNALC::Pipeline::User ();
	use DNALC::Pipeline::Group ();
	use DNALC::Pipeline::UserProfile ();
	use Email::Valid ();
	use MIME::Lite ();
	
	use Data::Dumper;
	
	my $VALUE_MAX_LEN = 2000; # max 2000 chars (what about utf8 ?!)

	my $fields = [
			{ id => "name_first", label => "First name", re => qr/.+/, maxlength => 64},
			{ id => "name_last", label => "Last name", re => qr/.+/, maxlength => 64},
			{ id => "username", label => "Username", re => qr/^[a-z0-9_-]+$/i, maxlength => 16},
			{ id => "email", type => "email", label => "Email", re => qr/\@/, maxlength => 120},
		];
	my @titles = qw/Ms Mr Miss PhD MBA MD Prof/;
	my %question_map = (
			country => 'q6',
			zip	=> 'q8',
		);
</%once>
%#-------------------------------------------------------------------
<%init>
$m->session->{pipeline_reg} ||= {};
my $s = $m->session->{pipeline_reg};

my @err = ();

my $tree_root = 2;
my $questions = undef;#$m->cache->get("question-tree-$tree_root");
unless (defined $questions) {
		$questions = DNALC::Pipeline::UserProfile->get_question_tree($tree_root);
		$m->cache->set("question-tree-$tree_root", $questions, "2m"); # set cache for X minutes
}
else {
	#print STDERR "cache: ", "question-tree-$tree_root", $/;
}

print STDERR "-" x 20, $/;
print STDERR "Session:\t", Dumper($s), $/;

if ($r->method eq "POST") {

	my $user_profile_data = {};
	#print STDERR "\t", Dumper(\%ARGS), $/;
	for (keys %ARGS) {
		$s->{$_} = substr $ARGS{$_}, 0, $VALUE_MAX_LEN;
		$user_profile_data->{$_} = $s->{$_} if $_ =~ /^q\d+/;
	}
	print STDERR "User profile data:\t", Dumper($user_profile_data), $/;

	my $cf = DNALC::Pipeline::Config->new->cf('PIPELINE');

	for (@$fields) {
		my $f = $_->{id};
		$s->{$f} = substr $ARGS{$f}, 0, $_->{maxlength} if defined $ARGS{$f};
		unless (defined $s->{$f} && $s->{$f} =~ $_->{re}) {
			push @err, "$_->{label} is missing or invalid!";
		}
	}
	
	if ($s->{username} && length($s->{username}) < 6) {
		push @err, "Username is too short. Use at least 6 chars.";
	}
	
	if (! defined $s->{country}  || $s->{country} eq '') {
		push @err, "Country is missing.";
	}
	if (!defined $s->{zip} || $s->{zip} eq '') {
		push @err, "Zip/Postal code is missing.";
	}

	unless (@err) {
		unless (Email::Valid->address($s->{email})) {
			push @err, "Email address is invalid!";
		}
		my $user = DNALC::Pipeline::User->search( username => $s->{username});
		if ($user || $s->{username} =~ /^(?:chado|guest|default|postgre|temp|mysql)/i) {
			push @err, "Username not available!";
		}
		else {
			my $cutils = DNALC::Pipeline::Chado::Utils->new(
							username => $s->{username},
							profile => $cf->{GMOD_PROFILE},
						);
			if ($cutils->check_db_exists($s->{username})) {
				push @err, "Username not available!";
			}
			$cutils->dbh->disconnect;
		}
	}
	
	unless (@err ) {
		# create passwd
		my $pwd = random_string(4, 15);

		# create account		
		my $u = eval {
				DNALC::Pipeline::User->create({
					username => $s->{username},
					password => $pwd,
					email => $s->{email},
					title => $s->{title},
					name_first => $s->{name_first},
					name_last => $s->{name_last},
				});
			};

		if ($@) {
			print STDERR "USER: ------------------------------------\n";
			print STDERR $@, "\n";
			print STDERR "USER: ------------------------------------\n";
			push @err, "Error creating user!";
		}
		else {
			# store country && zip code
			for (keys %question_map ) {
				print STDERR "DD: ", $_, " = ", $question_map{$_}, " = ", $s->{$_}, $/;
			}
			my %data_directly = map {$question_map{$_} => $s->{$_}} grep {$s->{$_} ne "" } keys %question_map;
			eval {
				DNALC::Pipeline::UserProfile->store_user_profile_directly($u->id, \%data_directly);
			};
			
			# store the rest of the profile questions
			eval {
				DNALC::Pipeline::UserProfile->store_user_profile($tree_root, $u->id, $user_profile_data);
			};
			if ($@) {
				print STDERR "USER PROFILE: ------------------------------------\n";
				print STDERR $@, "\n";
				print STDERR "USER PROFILE: ------------------------------------\n";
			}
			
			# launch "create-chado-db" in the background

			my ($users_group) = DNALC::Pipeline::Group->search(group_name => "user");
			$u->add_to_group($users_group) if $users_group;

			my $code = $u->create_reset_pwd_code;
			$u->set_reset_pwd_code($code);

			if ($code) {
				my $text = "Dear user,\n
Thank you for creating an account.\n
Your unsername is: \"$s->{username}\" (without the quotes).\n
To set your password follow this link:
$cf->{APOLLO_PROJECT_HOME}/resetpass.html?c=$code\n
DNALC Team";

				# send mail to the applicant
				my $msg = MIME::Lite->new (
							From => '"Admin" <dnalcadmin@cshl.edu>',
							To	=> $s->{email},
							Subject => "Set your password",
							Type	=> 'text/plain',
							Data	=> $text
						);
				eval {
					if (defined $cf->{SMTP_SERVER} && $cf->{SMTP_SERVER} ne "") {
						$msg->send("smtp", $cf->{SMTP_SERVER}, Timeout=>30);
					}
					else {
						$msg->send;
					}
					
				};
				if ($@) {
					print STDERR "Error: " . $@ . "\n";
					$msg->send;
				}
			}			

			$m->comp("/_message_add", "Account created. You will receive an email with further instructions.");

			# clear registration session
			$m->session->{pipeline_reg} = {};
			$m->redirect("/");
		}
	}
}

</%init>

<%attr>
	js => ['user_profile.js']
</%attr>

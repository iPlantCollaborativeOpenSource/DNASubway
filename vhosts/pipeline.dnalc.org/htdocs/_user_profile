

% for my $q_id (sort {$questions->{$a}->{q}->{q_order_num} <=> $questions->{$b}->{q}->{q_order_num}} keys %$questions) {
%	my $q = $questions->{$q_id}->{q};
%	my $ah = $questions->{$q_id}->{a};
%#array of sortes posible answers for the current question
%	my @aa = map {$ah->{$_}} sort { $ah->{$a}->{q_order_num} <=> $ah->{$b}->{q_order_num} } keys %$ah;
%	my @labels = map {$_->{q_label}} grep {$_->{q_input_type} ne "other"} @aa;
%	my @values = map {$_->{q_id}} grep {$_->{q_input_type} ne "other"} @aa;
%	my ($triggerer, $triggered) = map {$_->{q_id}, $_->{q_triggers}} grep {defined $_->{q_triggers} && defined $ah->{$_->{q_triggers}}} @aa;
%	my ($other) = grep {$_->{q_input_type} eq "other"} @aa;
%	my $other_answered = $ah->{ $answers->{"q$q_id"} };
%#	look for any answers that trigger a question (not an answer from the current question)
%	my (@answers_triggering_question) = grep { defined $_->{q_triggers} && !defined $ah->{$_->{q_triggers}} } @aa;
<tr style="background-color: <% $depth ? $colors[$depth] : "inherit"%>;" parent="<% $parent %>">
	<td><% $parent %>"||<% $q->{q_label} %></td>
	<td>
%#		<span style="color: red">q<%$q_id%> ~~ <b><% $answers->{"q$q_id"} %></b> == <% $triggerer %> -» <% $triggered %></span>
%#		<span style="color: green">other_answered:<% $other_answered->{q_triggers} %> = other:<% $other->{q_id} %></span>
%	if ($q->{q_input_type} eq 'select') {
%		my $onchange = $triggered == $other->{q_id} ? "show_other('q$q_id', 'cq$triggered', '$triggerer');" : '';
%		if (@answers_triggering_question) {
%			$onchange .= "load_profile_questions('q$q_id', {" 
%						. join (',', map { $_->{q_triggers} . ':' . $_->{q_id} } @answers_triggering_question)
%						. "})";
%#	$answer_triggering_question->{q_triggers} . "','" . $answer_triggering_question->{q_id} . "');" : '';
%		}
		<& ".select", name=> "q$q_id", selected => $answers->{"q$q_id"},
			label => "Select " . $q->{q_label},
			labels => \@labels, values => \@values, 
			onchange => $onchange,
		&>
%	} elsif ($q->{q_input_type} eq 'radio') {
		<& ".radio", name=> "q$q_id", checked => $answers->{"q$q_id"}, labels => \@labels, values => \@values &>
%	} else {
		<input type="text" name="q<% $q_id%>" id="q<% $q_id%>" value="<% $answers->{"q$q_id"} |html %>" />
%	}
	</td>
</tr>
%	if ($other) {
%	my $show_other = defined $other_answered->{q_triggers} && $other_answered->{q_triggers} == $other->{q_id};
<!-- OTHER answer for this question = <% $answers->{"q$q_id"} %>-->
<tr id="cq<% $other->{q_id} %>" style="display: <% $show_other ? "table-row" : "none" %>;" parent="<% $parent %>">
	<td style="text-align: right;"><small><% $other->{q_label} %> » </small></td>
	<td>
%#		<input type="text" name="q<% $q_id%>_other" id="q<% $q_id%>_other" value="<% $triggers %>" />
		<input type="text" name="q<% $other->{q_id} %>" id="q<% $other->{q_id} %>" value="<% $show_other ? $answers->{"q" . $other->{q_id}} : "" %>" />
	</td>
</tr>
%	}
%#	print STDERR "**\t", $answer_triggering_question->{q_id}, " == ", $answers->{"q$q_id"}, $/;
%#	if we have an answer to the current question and the answer has a trigger and the trigger is not in the current list of answers
%	my ($answer_triggering_question) = grep {$_->{q_id} == $answers->{"q$q_id"} } @answers_triggering_question;
% 	if (defined $answers->{"q$q_id"} && defined $ah->{$answers->{"q$q_id"}} && $answer_triggering_question) {
%#		print STDERR "**\t", $answer_triggering_question->{q_id}, " == ", $answers->{"q$q_id"}, $/;
%#		print STDERR "Triggered question: ", $answer_triggering_question->{q_triggers}, " by q = ", "q$q_id / a = ", $answer_triggering_question->{q_id}, $/;
%		my $new_root = $answer_triggering_question->{q_triggers};
%		my $sub_tree = DNALC::Pipeline::UserProfile->get_question_tree( $new_root );
<tr parent="<% $parent %>"><td colspan="2"><hr /></td></tr>
<!-- SUBTREE starts -->
	<& "./_user_profile", questions => $sub_tree, answers => $answers, parent => "q$q_id", depth => $depth + 1 &>
<!-- SUBTREE ends -->
<tr parent="<% $parent %>"><td colspan="2"><hr /></td></tr>
%	}
% }

%#-----------------------------
<%args>
	$questions => {}
	$answers => {}
	$depth => 0
	$parent => 0
</%args>
%#-----------------------------
<%once>
	use Data::Dumper;
	my @colors = (qw/inherit silver grey/);
</%once>
%#-----------------------------
%#-----------------------------
<%def .select>
<%args>
	$name => 'select'
	$selected => ''
	$label => 'Select'
	$labels => [],
	$values => [],
	$onchange => ''
</%args>
<%init>

</%init>
	<select name="<% $name %>" id="<% $name%>" <% $onchange ? "onchange=\"$onchange\"" : "" %>>
		<option value=""><% $label |html%></option>
%	for (my $i = 0; $i < scalar @$labels; $i++) {
%		my $sel = $selected == $values->[$i] ? "selected=\"selected\"" : "";
		<option value="<% $values->[$i] %>" <% $sel %>><% $labels->[$i] |html%></option>
%	}
	</select>
</%def>
%#-----------------------------
<%def .radio>
<%args>
	$name => 'radio'
	$checked => '',
	$labels => [],
	$values => [],
	$onchange => ''
</%args>
%	for (my $i = 0; $i < scalar @$labels; $i++) {
%		my $chk = $checked == $values->[$i] ? "checked=\"checked\"" : "";
		<div style="cursor:pointer;">
			<input type="radio" name="<% $name %>" id="<% $name%>-<% $i %>" value="<% $values->[$i] %>" <% $chk %>/>&nbsp;
			<span onclick="javascript:$('<% $name %>-<% $i %>').click();"><% $labels->[$i] |html%></span>
		</div>
%	}
</%def>
%#-----------------------------
